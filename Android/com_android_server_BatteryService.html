<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>com_android_server_BatteryService</title>
    <!--格式化代码的特效脚本-->
    <script type="text/javascript" src="scripts/shCore.js"></script>
    <script type="text/javascript" src="scripts/shBrushBash.js"></script>
    <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCss.js"></script>
    <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
    <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
    <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
    <script type="text/javascript" src="scripts/shBrushJava.js"></script>
    <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
    <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
    <script type="text/javascript" src="scripts/shBrushPython.js"></script>
    <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
    <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
    <script type="text/javascript" src="scripts/shBrushScala.js"></script>
    <script type="text/javascript" src="scripts/shBrushSql.js"></script>
    <script type="text/javascript" src="scripts/shBrushVb.js"></script>
    <script type="text/javascript" src="scripts/shBrushXml.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/shCoreZenki.css"/>
    <link type="text/css" rel="stylesheet" href="styles/shThemeZenki.css"/>
    <script type="text/javascript">
        SyntaxHighlighter.all();
    </script>
	<link type="text/css" rel="stylesheet" href="css_style/style_zenki.css"/>

</head>

<body>
<div id="wrapper">
<header>

<div id="logo">
</div>

<nav>
    <ul>
        <!--<li class="first"><a href="diary/diary.html">日记</a></li>-->
     </ul>
</nav>
</header>

<article>


<h1 id="toc_1">电池电量信息获取</h1>

<div class="toc">
<ul>
<li><a href="#toc_1">电池电量信息获取</a></li>
<ul>
<li><a href="#toc_1.1">相关变量</a></li>
<li><a href="#toc_1.2">代码分析</a></li>
<ul>
<li><a href="#toc_1.2.1">电量信息路径定义</a></li>
<li><a href="#toc_1.2.2">更新电量信息</a></li>
<li><a href="#toc_1.2.3">提供给Java层的接口</a></li>
<li><a href="#toc_1.2.4">读取电池信息</a></li>
<li><a href="#toc_1.2.5">读取文件方法</a></li>
</ul>
</ul>
</ul>
</div>

<h2 id="toc_1.1">相关变量</h2>
<pre class="brush:c++">
struct FieldIds {
    jfieldID mAcOnline;
    ......
};
static FieldIds gFieldIds;

// 电池状态标识
struct BatteryManagerConstants {
    jint statusUnknown;
    ......
};
static BatteryManagerConstants gConstants;

// 各种电池信息的地址
struct PowerSupplyPaths {
    char* acOnlinePath;
    ......
};
static PowerSupplyPaths gPaths;

static int gVoltageDivisor = 1;
</pre>

<h2 id="toc_1.2">代码分析</h2>
<h3 id="toc_1.2.1">电量信息路径定义</h3>
<ul>
<li>
当电池状态发生变化时，driver会更新下面这些文件
</li>
</ul>

<pre class="brush:c++">
#define POWER_SUPPLY_PATH "/sys/class/power_supply"

// 各种信息对应的路径定义
#define AC_ONLINE_PATH "/sys/class/power_supply/ac/online"                      // AC电源连接状态
#define USB_ONLINE_PATH "/sys/class/power_supply/usb/online"                    // USB电源连接状态
#define BATTERY_STATUS_PATH "/sys/class/power_supply/battery/status"            // 充电状态
#define BATTERY_HEALTH_PATH "/sys/class/power_supply/battery/health"            // 电池状态
#define BATTERY_PRESENT_PATH "/sys/class/power_supply/battery/present"          // 使用状态
#define BATTERY_CAPACITY_PATH "/sys/class/power_supply/battery/capacity"        // 电池level
#define BATTERY_VOLTAGE_PATH "/sys/class/power_supply/battery/batt_vol"         // 电池电压
#define BATTERY_TEMPERATURE_PATH "/sys/class/power_supply/battery/batt_temp"    // 电池温度
#define BATTERY_TECHNOLOGY_PATH "/sys/class/power_supply/battery/technology"    // 电池技术
</pre>

<h3 id="toc_1.2.2">更新电量信息</h3>
<pre class="brush:c++">
// 该方法将电池信息传递给BatteryService
static void android_server_BatteryService_update(JNIEnv* env, jobject obj)
{
    setBooleanField(env, obj, gPaths.acOnlinePath, gFieldIds.mAcOnline);
    setBooleanField(env, obj, gPaths.usbOnlinePath, gFieldIds.mUsbOnline);
    setBooleanField(env, obj, gPaths.batteryPresentPath, gFieldIds.mBatteryPresent);
    
    setIntField(env, obj, gPaths.batteryCapacityPath, gFieldIds.mBatteryLevel);
    setVoltageField(env, obj, gPaths.batteryVoltagePath, gFieldIds.mBatteryVoltage);
    setIntField(env, obj, gPaths.batteryTemperaturePath, gFieldIds.mBatteryTemperature);
    
    const int SIZE = 128;
    char buf[SIZE];
    
    if (readFromFile(gPaths.batteryStatusPath, buf, SIZE) &gt; 0)
        env-&gt;SetIntField(obj, gFieldIds.mBatteryStatus, getBatteryStatus(buf));
    else
        env-&gt;SetIntField(obj, gFieldIds.mBatteryStatus,
                         gConstants.statusUnknown);
    
    if (readFromFile(gPaths.batteryHealthPath, buf, SIZE) &gt; 0)
        env-&gt;SetIntField(obj, gFieldIds.mBatteryHealth, getBatteryHealth(buf));

    if (readFromFile(gPaths.batteryTechnologyPath, buf, SIZE) &gt; 0)
        env-&gt;SetObjectField(obj, gFieldIds.mBatteryTechnology, env-&gt;NewStringUTF(buf));
}
</pre>

<h3 id="toc_1.2.3">提供给Java层的接口</h3>
<pre class="brush:c">
static JNINativeMethod sMethods[] = {
     /* name, signature, funcPtr */
	{"native_update", "()V", (void*)android_server_BatteryService_update},
};
</pre>

<h3 id="toc_1.2.4">读取电池信息</h3>
<pre class="brush:c++">
// 该方法从文件中读取电量信息数据
int register_android_server_BatteryService(JNIEnv* env)
{
    char    path[PATH_MAX];
    struct dirent* entry;

    // 打开电池信息文件
    DIR* dir = opendir(POWER_SUPPLY_PATH);
    if (dir == NULL) {
        LOGE("Could not open %s\n", POWER_SUPPLY_PATH);
        return -1;
    }
    
    // 读取电池信息文件夹中对应信息的数据
    while ((entry = readdir(dir))) {
        const char* name = entry-&gt;d_name;

        // ignore "." and ".."
        if (name[0] == '.' &amp;&amp; (name[1] == 0 || (name[1] == '.' &amp;&amp; name[2] == 0))) {
            continue;
        }

        char buf[20];
        // Look for "type" file in each subdirectory
        snprintf(path, sizeof(path), "%s/%s/type", POWER_SUPPLY_PATH, name);
        int length = readFromFile(path, buf, sizeof(buf));
        if (length &gt; 0) {
            if (buf[length - 1] == '\n')
                buf[length - 1] = 0;

            if (strcmp(buf, "Mains") == 0) {
                snprintf(path, sizeof(path), "%s/%s/online", POWER_SUPPLY_PATH, name);
                if (access(path, R_OK) == 0)
                    gPaths.acOnlinePath = strdup(path);
            }
            else if (strcmp(buf, "USB") == 0) {
                snprintf(path, sizeof(path), "%s/%s/online", POWER_SUPPLY_PATH, name);
                if (access(path, R_OK) == 0)
                    gPaths.usbOnlinePath = strdup(path);
            }
            else if (strcmp(buf, "Battery") == 0) {
                snprintf(path, sizeof(path), "%s/%s/status", POWER_SUPPLY_PATH, name);
                if (access(path, R_OK) == 0)
                    gPaths.batteryStatusPath = strdup(path);
                snprintf(path, sizeof(path), "%s/%s/health", POWER_SUPPLY_PATH, name);
                if (access(path, R_OK) == 0)
                    gPaths.batteryHealthPath = strdup(path);
                snprintf(path, sizeof(path), "%s/%s/present", POWER_SUPPLY_PATH, name);
                if (access(path, R_OK) == 0)
                    gPaths.batteryPresentPath = strdup(path);
                snprintf(path, sizeof(path), "%s/%s/capacity", POWER_SUPPLY_PATH, name);
                if (access(path, R_OK) == 0)
                    gPaths.batteryCapacityPath = strdup(path);

                ......
            }
        }
    }
    closedir(dir);

    ......
       
    // 获取BatteryService中分配的变量，用于读取电池信息
    gFieldIds.mAcOnline = env-&gt;GetFieldID(clazz, "mAcOnline", "Z");
    gFieldIds.mUsbOnline = env-&gt;GetFieldID(clazz, "mUsbOnline", "Z");
    gFieldIds.mBatteryHealth = env-&gt;GetFieldID(clazz, "mBatteryHealth", "I");
    gFieldIds.mBatteryVoltage = env-&gt;GetFieldID(clazz, "mBatteryVoltage", "I");
    gFieldIds.mBatteryTemperature = env-&gt;GetFieldID(clazz, "mBatteryTemperature", "I");
    ......

    clazz = env-&gt;FindClass("android/os/BatteryManager");
    
    if (clazz == NULL) {
        LOGE("Can't find android/os/BatteryManager");
        return -1;
    }
    
    // 从BatteryService获取状态值
    gConstants.healthGood = env-&gt;GetStaticIntField(clazz, 
            env-&gt;GetStaticFieldID(clazz, "BATTERY_HEALTH_GOOD", "I"));

    gConstants.healthOverheat = env-&gt;GetStaticIntField(clazz, 
            env-&gt;GetStaticFieldID(clazz, "BATTERY_HEALTH_OVERHEAT", "I"));
    ......

    return jniRegisterNativeMethods(env, "com/android/server/BatteryService", sMethods, NELEM(sMethods));
}
</pre>

<h3 id="toc_1.2.5">读取文件方法</h3>
<pre class="brush:c++">
static int readFromFile(const char* path, char* buf, size_t size)
{
    if (!path)
        return -1;
    int fd = open(path, O_RDONLY, 0);
    if (fd == -1) {
        LOGE("Could not open '%s'", path);
        return -1;
    }
    
    size_t count = read(fd, buf, size);
    if (count &gt; 0) {
        count = (count &lt; size) ? count : size - 1;
        while (count &gt; 0 &amp;&amp; buf[count-1] == '\n') count--;
        buf[count] = '\0';
    } else {
        buf[0] = '\0';
    } 

    close(fd);
    return count;
}
</pre>
<footer>
    <a href="index.html" id="back-home">首页</a>
    <a href="index.html" id="back-about">关于</a>
    <a href="http://www.163.com/" id="back-email">Email</a>
</footer>

</article>
</div>

<!--<script type="text/javascript">-->
<!--var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");-->
<!--document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));-->
<!--</script>-->
<!--<script type="text/javascript">-->
<!--try {-->
<!--var pageTracker = _gat._getTracker("UA-15922433-1");-->
<!--pageTracker._trackPageview();-->
<!--} catch(err) {}-->
<!--</script>-->

</body>
</html>
