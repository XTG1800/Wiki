<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>编译Android源码</title>
    <!--格式化代码的特效脚本-->
    <script type="text/javascript" src="scripts/shCore.js"></script>
    <script type="text/javascript" src="scripts/shBrushBash.js"></script>
    <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCss.js"></script>
    <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
    <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
    <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
    <script type="text/javascript" src="scripts/shBrushJava.js"></script>
    <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
    <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
    <script type="text/javascript" src="scripts/shBrushPython.js"></script>
    <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
    <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
    <script type="text/javascript" src="scripts/shBrushScala.js"></script>
    <script type="text/javascript" src="scripts/shBrushSql.js"></script>
    <script type="text/javascript" src="scripts/shBrushVb.js"></script>
    <script type="text/javascript" src="scripts/shBrushXml.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/shCoreZenki.css"/>
    <link type="text/css" rel="stylesheet" href="styles/shThemeZenki.css"/>
    <script type="text/javascript">
        SyntaxHighlighter.all();
    </script>
    <link rel="Stylesheet" type="text/css" href="../css_style/style_zenki.css">

</head>

<body>
<div id="wrapper">
<header>

<div id="logo">
</div>

<nav>
    <ul>
        <!--<li class="first"><a href="diary/diary.html">日记</a></li>-->
     </ul>
</nav>
</header>

<article>

<!-- wrap the vimwiki html -->

<h1 id="toc_1">如何编译Android</h1>

<div class="toc">
<ul>
<li><a href="#toc_1">如何编译Android</a>
<ul>
<li><a href="#toc_1.1">官方的连接地址</a>
<li><a href="#toc_1.2">安装编译环境</a>
<li><a href="#toc_1.3">设置环境变量</a>
<li><a href="#toc_1.4">编译整个Android</a>
<li><a href="#toc_1.5">制作uboot启动的ramdisk</a>
<li><a href="#toc_1.6">编译镜像</a>
<li><a href="#toc_1.7">增量编译</a>
</ul>
</ul>
</div>

<h2 id="toc_1.1">官方的连接地址</h2>
<dl>
<dt>配置环境 </dt>
<dd><a href="http://source.android.com/source/initializing.html</dd>">http://source.android.com/source/initializing.html</dd></a>
<dt>编译 </dt>
<dd><a href="http://source.android.com/source/building.html</dd>">http://source.android.com/source/building.html</dd></a>
<dt>问题1 </dt>
<dd><a href="http://www.linuxidc.com/Linux/2011-07/38430.htm</dd>">http://www.linuxidc.com/Linux/2011-07/38430.htm</dd></a>
<dt>问题2 </dt>
<dd><a href="http://www.cnblogs.com/dwayne/archive/2011/11/16/2251734.html">http://www.cnblogs.com/dwayne/archive/2011/11/16/2251734.html</a>  </dd>
</dl>

<h2 id="toc_1.2">安装编译环境</h2>
<pre class="brush: bash">
$ sudo apt-get install git-core gnupg sun-java5-jdk flex bison gperf \
            libsdl-dev libesd0-dev libwxgtk2.6-dev build-essential   \
            zip curl libncurses5-dev zlib1g-dev 

# 根据版本可选择安装jdk6
$ sudo apt-get install sun-java6-jdk

# 64位系统可选择安装以下包
$ sudo apt-get install g++-4.3 g++-4.3-multilib gcc-4.3-multilib gcc-4.3
</pre>

<h2 id="toc_1.3">设置环境变量</h2>
<pre class="brush: bash">
vim ~/.bashrc

####设置以下变量####
JAVA_HOME=/usr/lib/jvm/java-6-sun
JRE_HOME=${JAVA_HOME}/jre
CLASSPATH=.:${JAVA_HOME}/lib:$JRE_HOME/lib:$CLASSPATH

export JAVA_HOME;
export JRE_HOME;
export CLASSPATH;
export JAVA_PATH=${JAVA_HOME}/bin:${JRE_HOME}/bin
export PATH=${PATH}:${JAVA_PATH};

source ~/.bashrc
</pre>

<h2 id="toc_1.4">编译整个Android</h2>
<p>
例如,刚把整个Android源码下载到~/android目录
</p>
<pre class="brush: bash">
$ cd ~/android
$ . build/envsetup.sh
$ lunch 1 #加载默认编译环境
$ make

# 输入help查看有用的命令
- croot:   Changes directory to the  of the tree.
- m:       Makes from the  of the tree.
- mm:      Builds all of the modules in the current directory.
- mmm:     Builds all of the modules in the supplied directories.
- cgrep:   Greps on all local C/C++ files.
- jgrep:   Greps on all local Java files.
- resgrep: Greps on all local res/*.xml files. 
</pre>
<p>
<strong>这个过程需要很长时间,之后在生成out目录,该编译不产生SDK</strong>
</p>
<pre class="brush: text">
~/android/out/target/product/generic    --- 系统镜像等文件
~/android/out/host/linux-x86/bin        --- android工具软件
</pre>

<h2 id="toc_1.5">制作uboot启动的ramdisk</h2>
<pre class="brush:bash">
$ mkdir inand_rootfs
$ cp -Rfp $OUT_PROD/root/* ./inand_rootfs

$ cd $OUT_PROD/inand_rootfs
$ find . | cpio -o -H newc | gzip &gt; ../ramdisk.img
$ cd ..
$ mkimage -A arm -O linux -T ramdisk -C none -a 0x80800000 -e 0x80800000 -n 'ramdisk-uboot' \
          -d ramdisk.img ramdisk-uboot.img
</pre>

<h2 id="toc_1.6">编译镜像</h2>
<ul>
<li>
编译时需要设置TARGET_PRODUCT变量，变量名为A0007.mk中的PRODUCT_NAME定义

<li>
APK签名请参考<a href="签名机制.html">签名机制</a>

<li>
发布版本请参考<a href="版本发布.html">版本发布</a>

</ul>

<pre class="brush:bash">
# 编译eng版的镜像
$ make PRODUCT-A0007-eng
或
$ make TARGET_PRODUCT=A0007 TARGET_BUILD_VARIANT=eng

# 编译user版的镜像
$ make PRODUCT-A0007-user
或
$ make TARGET_PRODUCT=A0007 TARGET_BUILD_VARIANT=user

# 生成发布系统
$ make -j4 PRODUCT-A0007-user dist
</pre>

<h2 id="toc_1.7">增量编译</h2>
<pre class="brush:bash">
# 1.编译修改的模块代码
cd ~/android/src 
mmm packages/apps/Contacts

# 2.生成新的系统镜像system.img
cd ~/android/src
make stnod

# 3.拷贝到目标目录
cp out/target/product/generic/system.img des/

# 4.删除遗留数据
emulator -wipe-data
</pre>


<footer>
    <a href="http://zenki2001cn.github.com/Wiki" id="back-home">首页</a>
    <a href="index.html" id="back-about">关于</a>
    <a href="zenki2001cn@163.com" id="back-email">Email</a>
</footer>

</article>
</div>

</body>
</html>
