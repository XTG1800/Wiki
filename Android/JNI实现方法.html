<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>JNI实现方法</title>
    <!--格式化代码的特效脚本-->
    <script type="text/javascript" src="scripts/shCore.js"></script>
    <script type="text/javascript" src="scripts/shBrushBash.js"></script>
    <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCss.js"></script>
    <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
    <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
    <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
    <script type="text/javascript" src="scripts/shBrushJava.js"></script>
    <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
    <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
    <script type="text/javascript" src="scripts/shBrushPython.js"></script>
    <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
    <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
    <script type="text/javascript" src="scripts/shBrushScala.js"></script>
    <script type="text/javascript" src="scripts/shBrushSql.js"></script>
    <script type="text/javascript" src="scripts/shBrushVb.js"></script>
    <script type="text/javascript" src="scripts/shBrushXml.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/shCoreZenki.css"/>
    <link type="text/css" rel="stylesheet" href="styles/shThemeZenki.css"/>
    <script type="text/javascript">
        SyntaxHighlighter.all();
    </script>
	<link type="text/css" rel="stylesheet" href="css_style/style_zenki.css"/>

</head>

<body>
<div id="wrapper">
<header>

<div id="logo">
</div>

<nav>
    <ul>
        <!--<li class="first"><a href="diary/diary.html">日记</a></li>-->
     </ul>
</nav>
</header>

<article>


<h1 id="toc_1">JNI实现方法</h1>

<div class="toc">
<ul>
<li><a href="#toc_1">JNI实现方法</a></li>
<ul>
<li><a href="#toc_1.1">示例代码解析</a></li>
<li><a href="#toc_1.2">使用和编译</a></li>
<ul>
<li><a href="#toc_1.2.1">JAVA部分</a></li>
<ul>
<li><a href="#toc_1.2.1.1">创建JAVA方法入口</a></li>
<li><a href="#toc_1.2.1.2">使用javah生成.h头文件</a></li>
</ul>
<li><a href="#toc_1.2.2">C部分</a></li>
<ul>
<li><a href="#toc_1.2.2.1">编译386平台的库</a></li>
<li><a href="#toc_1.2.2.2">编译ARM平台的库</a></li>
<li><a href="#toc_1.2.2.3">编写Android.mk</a></li>
<li><a href="#toc_1.2.2.4">执行Android编译命令</a></li>
</ul>
</ul>
</ul>
</ul>
</div>

<h2 id="toc_1.1">示例代码解析</h2>
<ul>
<li>
<a href="加入JNI图解.html">加入JNI图解</a>
</li>
<li>
<a href="Java和C数据类型接口.html">Java和C数据类型接口</a>
</li>
<li>
<a href="jni使用范例.html">jni使用范例</a>
</li>
</ul>

<h2 id="toc_1.2">使用和编译</h2>
<h3 id="toc_1.2.1">JAVA部分</h3>
<ul>
<li>
创建java类，声明C的调用接口，通常是native类型的方法声明
</li>
<li>
使用javac编译生成.class文件
</li>
<li>
使用javah生成.h文件
</li>
</ul>

<h4 id="toc_1.2.1.1">创建JAVA方法入口</h4>
<pre class="brush:java">
public class Test {
    static {
        // 打印库路径
        System.out.println(System.getProperty("java.library.path"));
        // 装载共享库文件
        System.loadLibrary("test");
    }

    // 本地调用声明为native类型
    public native static void hello();
    public native static int hello2(String[] str);
    public native static void hello3(String[] str, int[] array);
    public native static void hello4(String[] str, int[] array, int i);

    public static void main (String [] args) {

        Test test = new Test();

        test.hello();
        test.hello2(null);
        test.hello3(null, null);
        test.hello4(null, null, 0);
    }
}
</pre>

<h4 id="toc_1.2.1.2">使用javah生成.h头文件</h4>
<pre class="brush:c">
#include &lt;jni.h&gt;
/* Header for class Test */

#ifndef _Included_Test
#define _Included_Test
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     Test
 * Method:    hello
 * Signature: ()V
 */
JNIEXPORT void JNICALL Java_Test_hello
  (JNIEnv *, jclass);

...
...
...

#ifdef __cplusplus
}
#endif
#endif
</pre>

<h3 id="toc_1.2.2">C部分</h3>
<ul>
<li>
根据javah生成的.h文件，实现其.c文件的代码
</li>
<li>
编译.c文件生成.so文件
</li>
</ul>

<h4 id="toc_1.2.2.1">编译386平台的库</h4>
<ul>
<li>
编写makefile，将.c文件编译成.o，注意包含jni.h头文件路径
</li>
<li>
使用gcc -shared -fPIC a.o -o a.so 生成动态库
</li>
<li>
确认动态库在java.library.path搜索目录中
</li>
</ul>

<h4 id="toc_1.2.2.2">编译ARM平台的库</h4>
<ul>
<li>
<code>在Android下编译时，java类中最好只包含native方法声明，去除冗余代码</code>
</li>
<li>
将工程目录拷贝到Android源代码的development目录下，编写Android.mk文件
</li>
<li>
在源码顶层目录使用<code>make module-name</code>编译生成.so文件，文件生成的目录为out/target/product/generic/obj/SHARED_LIBRARIES/中
</li>
<li>
Android.mk中加入<code>LOCAL_PRELINK_MODULE := false</code>防止prelink操作导致编译失败
</li>
</ul>

<h4 id="toc_1.2.2.3">编写Android.mk</h4>
<pre class="brush:c">
LOCAL_PATH:= $(call my-dir)
include $(CLEAR_VARS)

#禁止Prelink
LOCAL_PRELINK_MODULE := false

LOCAL_C_INCLUDES += \
    $(JNI_H_INCLUDE)
    
# 源文件目录
LOCAL_SRC_FILES := \
    Test.c Test.h

# 模块名
LOCAL_MODULE := libtest

# 创建共享库
include $(BUILD_SHARED_LIBRARY)
</pre>

<h4 id="toc_1.2.2.4">执行Android编译命令</h4>
<pre class="brush:bash">
make libtest

# 清除命令
make clean-libtest
</pre>
<footer>
    <a href="index.html" id="back-home">首页</a>
    <a href="index.html" id="back-about">关于</a>
    <a href="http://www.163.com/" id="back-email">Email</a>
</footer>

</article>
</div>

<!--<script type="text/javascript">-->
<!--var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");-->
<!--document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));-->
<!--</script>-->
<!--<script type="text/javascript">-->
<!--try {-->
<!--var pageTracker = _gat._getTracker("UA-15922433-1");-->
<!--pageTracker._trackPageview();-->
<!--} catch(err) {}-->
<!--</script>-->

</body>
</html>
