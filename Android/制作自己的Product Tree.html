<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>制作自己的Product Tree</title>
    <!--格式化代码的特效脚本-->
    <script type="text/javascript" src="scripts/shCore.js"></script>
    <script type="text/javascript" src="scripts/shBrushBash.js"></script>
    <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCss.js"></script>
    <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
    <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
    <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
    <script type="text/javascript" src="scripts/shBrushJava.js"></script>
    <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
    <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
    <script type="text/javascript" src="scripts/shBrushPython.js"></script>
    <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
    <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
    <script type="text/javascript" src="scripts/shBrushScala.js"></script>
    <script type="text/javascript" src="scripts/shBrushSql.js"></script>
    <script type="text/javascript" src="scripts/shBrushVb.js"></script>
    <script type="text/javascript" src="scripts/shBrushXml.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/shCoreZenki.css"/>
    <link type="text/css" rel="stylesheet" href="styles/shThemeZenki.css"/>
    <script type="text/javascript">
        SyntaxHighlighter.all();
    </script>
	<link type="text/css" rel="stylesheet" href="css_style/style_zenki.css"/>

</head>

<body>
<div id="wrapper">
<header>

<div id="logo">
</div>

<nav>
    <ul>
        <!--<li class="first"><a href="diary/diary.html">日记</a></li>-->
     </ul>
</nav>
</header>

<article>


<h1 id="toc_1">如何制作自己的Product Tree</h1>
<div class="toc">
<ul>
<li><a href="#toc_1">如何制作自己的Product Tree</a></li>
<ul>
<li><a href="#toc_1.1">三个重要的Makefile</a></li>
<li><a href="#toc_1.2">基本流程</a></li>
<ul>
<li><a href="#toc_1.2.1">1.拷贝sample目录</a></li>
<li><a href="#toc_1.2.2">2.创建product-specific文件</a></li>
<li><a href="#toc_1.2.3">3.修改AndroidProducts.mk</a></li>
<li><a href="#toc_1.2.4">4.创建board-specific目录</a></li>
<li><a href="#toc_1.2.5">5.创建BoardConfig.mk</a></li>
<li><a href="#toc_1.2.6">6.创建system.prop(可选)</a></li>
<li><a href="#toc_1.2.7">7.创建板子的Android.mk(可选)</a></li>
<li><a href="#toc_1.2.8">8.编写A0007.mk(可继承的mk)</a></li>
<li><a href="#toc_1.2.9">9.继承A0007.mk</a></li>
<li><a href="#toc_1.2.10">10.修改AndroidProducts.mk</a></li>
<li><a href="#toc_1.2.11">*.添加第二个product(可选)</a></li>
<ul>
<li><a href="#toc_1.2.11.1">添加second_product_name.mk</a></li>
<li><a href="#toc_1.2.11.2">修改AndroidProducts.mk</a></li>
</ul>
<li><a href="#toc_1.2.12">*.添加环境设置脚本(可选)</a></li>
</ul>
<li><a href="#toc_1.3">最终目录结构</a></li>
<li><a href="#toc_1.4">编译镜像</a></li>
</ul>
</ul>
</div>

<p>
<em>Android源码下的vendor用来提供各厂商自己的配置，通过修改该目录中的文件可以生成自定义系统</em>
</p>

<h2 id="toc_1.1">三个重要的Makefile</h2>
<pre class="brush:text">
AndroidProducts.mk
BoardConfig.mk
A0007.mk(自定义)
</pre>

<h2 id="toc_1.2">基本流程</h2>
<h3 id="toc_1.2.1">1.拷贝sample目录</h3>
<ul>
<li>
拷贝一份device中的sample目录，该为公司相关的名称
</li>
</ul>

<pre class="brush:bash">
$ cp -r sample &lt;company_name&gt;
</pre>

<h3 id="toc_1.2.2">2.创建product-specific文件</h3>
<ul>
<li>
创建一个product相关的mk文件，取名为<code>device/&lt;company_name&gt;/products/&lt;first_product_name&gt;.mk</code>，并包含以下内容
</li>
</ul>

<pre class="brush:bash">
$(call inherit-product, $(SRC_TARGET_DIR)/product/generic.mk)

# Overrides
PRODUCT_NAME := &lt;first_product_name&gt;
PRODUCT_DEVICE := &lt;board_name&gt;
</pre>

<h3 id="toc_1.2.3">3.修改AndroidProducts.mk</h3>
<ul>
<li>
修改products目录下的AndroidProducts.mk，添加以下内容，将PRODUCT_MAKEFILES指向上一步所添加的&lt;first_product_name&gt;.mk
</li>
</ul>

<pre class="brush:bash">
# 包含第一个product的mk文件
PRODUCT_MAKEFILES := \
    $(LOCAL_DIR)/first_product_name.mk \
</pre>

<h3 id="toc_1.2.4">4.创建board-specific目录</h3>
<ul>
<li>
创建一个board相关的目录，取名为board_name——PRODUCT_DEVICE定义
</li>
</ul>

<pre class="brush:bash">
$ mkdir device/&lt;company_name&gt;/&lt;board_name&gt;
</pre>

<h3 id="toc_1.2.5">5.创建BoardConfig.mk</h3>
<ul>
<li>
在device/&lt;company_name&gt;/&lt;board_name&gt;下创建<code>BoardConfig.mk</code>，该文件由编译系统自动搜索并加载
</li>
</ul>

<pre class="brush:bash">
# These definitions override the defaults in config/config.make for &lt;board_name&gt;
#
# TARGET_NO_BOOTLOADER := false
# TARGET_HARDWARE_3D := false 
#
TARGET_USE_GENERIC_AUDIO := true
TARGET_NO_BOOTLOADER := true
TARGET_NO_KERNEL := true
TARGET_NO_RADIOIMAGE := true
TARGET_CPU_ABI := armeabi
HAVE_HTC_AUDIO_DRIVER := true
BOARD_USES_GENERIC_AUDIO := true
</pre>

<h3 id="toc_1.2.6">6.创建system.prop(可选)</h3>
<ul>
<li>
这个步骤是可选的，如果你需要设置一些系统属性，则在device/&lt;company_name&gt;/&lt;board_name&gt;下创建<code>system.prop</code>文件，并加入以下内容
</li>
</ul>

<pre class="brush:bash">
# system.prop for 
# This overrides settings in the products/generic/system.prop file
#
# rild.libpath=/system/lib/libreference-ril.so
# rild.libargs=-d /dev/ttyS0
</pre>

<h3 id="toc_1.2.7">7.创建板子的Android.mk(可选)</h3>
<ul>
<li>
这个步骤是可选的，如果你需要编译内核，则在device/&lt;company_name&gt;/&lt;board_name&gt;下创建<code>Android.mk</code>文件，并加入以下内容
</li>
</ul>

<pre class="brush:bash">
# make file for new hardware  from 

LOCAL_PATH := $(call my-dir)

# this is here to use the pre-built kernel
ifeq ($(TARGET_PREBUILT_KERNEL),)
TARGET_PREBUILT_KERNEL := $(LOCAL_PATH)/kernel
endif


file := $(INSTALLED_KERNEL_TARGET)
ALL_PREBUILT += $(file)
$(file): $(TARGET_PREBUILT_KERNEL) | $(ACP)
$(transform-prebuilt-to-target)

# no boot loader, so we don't need any of that stuff..  
LOCAL_PATH := partner/&lt;company_name&gt;/&lt;board_name&gt;

include $(CLEAR_VARS)

# include more board specific stuff here? Such as Audio parameters.      
</pre>

<h3 id="toc_1.2.8">8.编写A0007.mk(可继承的mk)</h3>
<ul>
<li>
将products目录下sample_addon.mk改名为A0007.mk，并修改相关内容。这样做的目的是创建一个产品相关的基类mk，其他型号相关mk可以直接继承它
</li>
<li>
device/&lt;company_name&gt;/products/&lt;first_product_name&gt;.mk作为具体的产品mk，需要inherit-product该文件
</li>
<li>
也可以将以下内容拷贝进first_product_name.mk，这种做法不适合扩展
</li>
<li>
相关变量设置参见<a href="Build环境变量.html">Build环境变量</a>
</li>
</ul>

<pre class="brush:bash">
# 该文件继承于$(SRC_TARGET_DIR)/products/generic.mk
$(call inherit-product, $(SRC_TARGET_DIR)/products/generic.mk)

# 按照规则查找需要build的文件夹，注意命名规则
# 参考device/sample示例
PRODUCT_PACKAGES := \
    PlatformLibraryClient \                     =》当前目录apps下的PlatformLibraryClient文件夹
    com.example.android.platform_library \      =》当前目录frameworks下的PlatformLibrary文件夹
    libplatform_library_jni                     =》当前目录frameworks下的PlatformLibrary下的jni文件夹
    
# 拷贝命令，定义需要拷贝的文件源与路径
PRODUCT_COPY_FILES := \
    vendor/mstar/etc/vold.conf:system/etc/vold.conf \
    vendor/mstar/bin/bash:system/bin/bash \
    vendor/mstar/em1/help.epub:system/usr/help.epub \
    vendor/mstar/em1/help.pdf:system/usr/help.pdf \
    vendor/mstar/etc/dhcpcd.conf:system/etc/dhcpcd/dhcpcd.conf \

# 拷贝jar库
PRODUCT_SDK_ADDON_COPY_MODULES := \
    com.example.android.platform_library:libs/platform_library.jar

# 键盘映射文件
PRODUCT_PACKAGES := \
    mg-capacitive.kcm
        
#set correct hardware
ADDITIONAL_DEFAULT_PROPERTIES += ro.hardware=3622

# 这组变量定义了编译出来的产品名称
# Use 'make PRODUCT-&lt;PRODUCT_NAME&gt;-eng' to build the A0007.
PRODUCT_BRAND := A0007
PRODUCT_LOCALES := \
    zh_CN \
    zh_TW \
    en_US
</pre>

<h3 id="toc_1.2.9">9.继承A0007.mk</h3>
<ul>
<li>
在device/&lt;company_name&gt;/products/&lt;first_product_name&gt;.mk中添加以下内容，用来继承A0007.mk
</li>
</ul>

<pre class="brush:bash">
$(call inherit-product, $(SRC_TARGET_DIR)/product/generic.mk)

# 继承A0007.mk
$(call inherit-product, device/&lt;company_name&gt;/products/A0007.mk)

# Overrides
PRODUCT_BRAND := <brand_name&gt;
PRODUCT_MANUFACTURER := &lt;manufacturer_name&gt;
PRODUCT_MODEL := &lt;model_name&gt;
</pre>

<h3 id="toc_1.2.10">10.修改AndroidProducts.mk</h3>
<pre class="brush:bash">
PRODUCT_MAKEFILES := \
    $(LOCAL_DIR)/first_product_name.mk
</pre>

<h3 id="toc_1.2.11">*.添加第二个product(可选)</h3>
<ul>
<li>
至此我们已经添加了一个product，如果需要添加其他product，可以从步骤2开始，创建second_product_name.mk
</li>
<li>
在AndroidProducts.mk中加入second_product_name.mk，并重复以上步骤
</li>
</ul>

<h4 id="toc_1.2.11.1">添加second_product_name.mk</h4>
<pre class="brush:bash">
$(call inherit-product, partner/google/products/generic.mk)

# 继承A0007.mk
$(call inherit-product, device/&lt;company_name&gt;/products/A0007.mk)

# Overrides
PRODUCT_NAME := &lt;second_product_name&gt;
PRODUCT_DEVICE := &lt;board_name&gt;
</pre>

<h4 id="toc_1.2.11.2">修改AndroidProducts.mk</h4>
<pre class="brush:bash">
PRODUCT_MAKEFILES := \
    $(LOCAL_DIR)/first_product_name.mk \
    $(LOCAL_DIR)/second_product_name.mk
</pre>

<h3 id="toc_1.2.12">*.添加环境设置脚本(可选)</h3>
<ul>
<li>
创建device/&lt;company_name&gt;/products/vendorsetup.sh，并添加以下内容
</li>
<li>
build系统会扫描以下文件
</li>
<ul>
<li>
vendor/*/vendorsetup.sh 
</li>
<li>
vendor/*/build/vendorsetup.sh 
</li>
<li>
device/<strong>/</strong>/vendorsetup.sh
</li>
</ul>
</ul>

<pre class="brush:bash">
add_lunch_combo A0007-user
</pre>

<h2 id="toc_1.3">最终目录结构</h2>
<ul>
<li>
&lt;company_name&gt;
</li>
<ul>
<li>
&lt;board_name&gt;
</li>
<ul>
<li>
Android.mk
</li>
<li>
product_config.mk
</li>
<li>
system.prop
</li>
</ul>
<li>
products
</li>
<ul>
<li>
AndroidProducts.mk
</li>
<li>
first_product_name.mk
</li>
<li>
second_product_name.mk
</li>
<li>
A0007.mk
</li>
<li>
vendorsetup.sh
</li>
</ul>
</ul>
</ul>

<h2 id="toc_1.4">编译镜像</h2>
<ul>
<li>
编译时需要设置TARGET_PRODUCT变量，变量名为A0007.mk中的PRODUCT_NAME定义
</li>
</ul>

<pre class="brush:bash">
# 编译eng版的镜像
$ make PRODUCT-A0007-eng
或
$ make TARGET_PRODUCT=A0007 TARGET_BUILD_VARIANT=eng

# 编译user版的镜像
$ make PRODUCT-A0007-user
或
$ make TARGET_PRODUCT=A0007 TARGET_BUILD_VARIANT=user
</pre>
<footer>
    <a href="index.html" id="back-home">首页</a>
    <a href="index.html" id="back-about">关于</a>
    <a href="http://www.163.com/" id="back-email">Email</a>
</footer>

</article>
</div>

<!--<script type="text/javascript">-->
<!--var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");-->
<!--document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));-->
<!--</script>-->
<!--<script type="text/javascript">-->
<!--try {-->
<!--var pageTracker = _gat._getTracker("UA-15922433-1");-->
<!--pageTracker._trackPageview();-->
<!--} catch(err) {}-->
<!--</script>-->

</body>
</html>
