<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>远程Service</title>
    <!--格式化代码的特效脚本-->
    <script type="text/javascript" src="scripts/shCore.js"></script>
    <script type="text/javascript" src="scripts/shBrushBash.js"></script>
    <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCss.js"></script>
    <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
    <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
    <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
    <script type="text/javascript" src="scripts/shBrushJava.js"></script>
    <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
    <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
    <script type="text/javascript" src="scripts/shBrushPython.js"></script>
    <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
    <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
    <script type="text/javascript" src="scripts/shBrushScala.js"></script>
    <script type="text/javascript" src="scripts/shBrushSql.js"></script>
    <script type="text/javascript" src="scripts/shBrushVb.js"></script>
    <script type="text/javascript" src="scripts/shBrushXml.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/shCoreZenki.css"/>
    <link type="text/css" rel="stylesheet" href="styles/shThemeZenki.css"/>
    <script type="text/javascript">
        SyntaxHighlighter.all();
    </script>
    <link rel="Stylesheet" type="text/css" href="../css_style/style_zenki.css">

</head>

<body>
<div id="wrapper">
<header>

<div id="logo">
</div>

<nav>
    <ul>
        <!--<li class="first"><a href="diary/diary.html">日记</a></li>-->
     </ul>
</nav>
</header>

<article>

<!-- wrap the vimwiki html -->

<h1 id="toc_1">远程Service</h1>

<div class="toc">
<ul>
<li><a href="#toc_1">远程Service</a>
<ul>
<li><a href="#toc_1.1">Binding Service</a>
<ul>
<li><a href="#toc_1.1.1">client端</a>
<li><a href="#toc_1.1.2">示例代码</a>
<ul>
<li><a href="#toc_1.1.2.1">ServiceConnection</a>
<li><a href="#toc_1.1.2.2">bindService和unbindService</a>
<li><a href="#toc_1.1.2.3">调用service方法</a>
</ul>
<li><a href="#toc_1.1.3">Service端</a>
<li><a href="#toc_1.1.4">示例代码</a>
<ul>
<li><a href="#toc_1.1.4.1">AIDL文件</a>
<li><a href="#toc_1.1.4.2">Stub接口</a>
<li><a href="#toc_1.1.4.3">Services实现</a>
</ul>
</ul>
<li><a href="#toc_1.2">Start Service</a>
<ul>
<li><a href="#toc_1.2.1">Client端</a>
<li><a href="#toc_1.2.2">Service端</a>
</ul>
<li><a href="#toc_1.3">Manifest</a>
<ul>
<li><a href="#toc_1.3.1">示例代码</a>
<ul>
<li><a href="#toc_1.3.1.1">服务端XML</a>
</ul>
</ul>
</ul>
</ul>
</div>

<h2 id="toc_1.1">Binding Service</h2>

<h3 id="toc_1.1.1">client端</h3>

<ul>
<li>
导入相应的AIDL接口文件，并<code>import</code>AIDL接口类的完整包路径,如<code>import com.example.android.apis.app.IRemoteService</code>

<li>
创建ServiceConnection对象，并实现<code>onServiceConnected</code>和<code>onServiceDisconnected</code>方法

<li>
调用bindService方法绑定Service

<li>
在调用远程方法时处理<code>RemoteException</code>异常

<li>
调用unbindService方法解除绑定

</ul>

<h3 id="toc_1.1.2">示例代码</h3>
<h4 id="toc_1.1.2.1">ServiceConnection</h4>

<pre class="brush:java">
IRemoteService mService = null;

private ServiceConnection mConnection = new ServiceConnection() {
    public void onServiceConnected(ComponentName className, IBinder service) {
        // 通过IDL接口获得远程IRemoteService对象
        mService = IRemoteService.Stub.asInterface(service);
        
        // 注意捕获异常
        try {
            // do something 
        }
        catch (RemoteException e) {
            // handle exception
            throw new RuntimeException(e);
        }
    }

    public void onServiceDisconnected(ComponentName className) {
        // This is called when the connection with the service has been
        // unexpectedly disconnected -- that is, its process crashed.
        mService = null;
    }
};
</pre>

<h4 id="toc_1.1.2.2">bindService和unbindService</h4>
<pre class="brush:java">
// 方法一
bindService(new Intent(IRemoteService.class.getName()),
            mConnection, Context.BIND_AUTO_CREATE);
            
// 方法二
bindService(new Intent("com.example.android.apis.app.IRemoteService"));
            
unbindService(mConnection);
</pre>

<h4 id="toc_1.1.2.3">调用service方法</h4>
<ul>
<li>
Android根据aidl自动生成相应的IRemoteService.Stub类，以下是其中一个方法的Proxy端实现。

<li>
客户端只要继承IRemoteService.Stub，并实现具体的<code>func1</code>方法即可。

<li>
Binder的Java端实现可参考<a href="Binder核心框架层_Java.html">Binder核心框架层_Java</a>
<pre class="brush:java">
private boolean func1(){
    byte val = 0;
    // 初始化Parcel对象
    Parcel query = Parcel.obtain();
    Parcel reply = Parcel.obtain();

    if (serviceIsNull())
        return false;

    try {
        // 声明服务
        query.writeInterfaceToken("com.android.music.IMediaPlaybackService");
        // 传送方法名称及参数
        mPlayerService.transact(IBinder.FIRST_CALL_TRANSACTION + PlaybackServiceFunc.INTERFACE_isPlaying.getId(), 
                                query, reply, 0);
        // 通过reply获取返回值
        val = reply.readByte();
    } catch(RemoteException e) {
        e.printStackTrace();
    }
    
    // 释放Parcel对象
    query.recycle();
    reply.recycle();

    return (val == PLAYING);
}
</pre>

</ul>

<h3 id="toc_1.1.3">Service端</h3>
<ul>
<li>
创建aidl文件，其中定义远程调用的接口，和方法声明

<li>
从Service派生对象，并实现<code>onCreate</code>，<code>onDestroy</code>和<code>onBind</code>方法

<li>
在派生类中，用户还需要实现一个Stub的内部类，实际上是用接口类代替Binder类

<li>
在<code>onBind</code>方法中，返回远程调用的接口类

</ul>

<h3 id="toc_1.1.4">示例代码</h3>
<h4 id="toc_1.1.4.1">AIDL文件</h4>

<ul>
<li>
IRemoteService.aidl
<pre class="brush:java">
package com.example.android.apis.app;

import com.example.android.apis.app.IRemoteServiceCallback;

interface IRemoteService {
    /**
     * Often you want to allow a service to call back to its clients.
     * This shows how to do so, by registering a callback interface with
     * the service.
     */
    void registerCallback(IRemoteServiceCallback cb);
    
    /**
     * Remove a previously registered callback interface.
     */
    void unregisterCallback(IRemoteServiceCallback cb);
}
</pre>

</ul>

<ul>
<li>
IRemoteServiceCallback.aidl
<pre class="brush:java">
package com.example.android.apis.app;

interfaces IRemoteServiceCallback {
    void callback();
}
</pre>

</ul>

<h4 id="toc_1.1.4.2">Stub接口</h4>
<pre class="brush:java">
// IDL定义的接口
private final IRemoteService.Stub mBinder = new IRemoteService.Stub() {
    // 自定义方法1
    public void registerCallback(IRemoteServiceCallback cb) {
        if (cb != null) mCallbacks.register(cb);
    }
    
    // 自定义方法2
    public void unregisterCallback(IRemoteServiceCallback cb) {
        if (cb != null) mCallbacks.unregister(cb);
    }
};
</pre>

<h4 id="toc_1.1.4.3">Services实现</h4>
<pre class="brush:java">
@Override
public void onCreate() {
    // do some thing
}

@Override
public void onDestroy() {
    // do some thing
}

@Override
public IBinder onBind(Intent intent) {
    // 返回IDL接口对象
    return mBinder;
}
</pre>

<h2 id="toc_1.2">Start Service</h2>
<h3 id="toc_1.2.1">Client端</h3>

<ul>
<li>
startService开启一个Service
<pre class="brush:java">
// 方法一
startService(new Intent(
        "com.example.android.apis.app.IRemoteService"));

// 方法二
startService(new Intent(IRemoteService.class.getName()));
</pre>

</ul>

<ul>
<li>
stopService停止一个Service
<pre class="brush:java">
// 方法一
stopService(new Intent(
        "com.example.android.apis.app.IRemoteService"));
        
// 方法二
stopService(new Intent(IRemoteService.class.getName()));
</pre>

</ul>

<h3 id="toc_1.2.2">Service端</h3>

<ul>
<li>
参见Binding Service

</ul>

<h2 id="toc_1.3">Manifest</h2>
<ul>
<li>
在xml中添加Service服务

</ul>

<h3 id="toc_1.3.1">示例代码</h3>
<h4 id="toc_1.3.1.1">服务端XML</h4>

<pre class="brush:xml">
&lt;service android:name=".app.RemoteService" android:process=":remote"&gt;
    &lt;intent-filter&gt;
        &lt;!-- 通过注册这些字符串标识，发送Intent绑定Service --&gt;
        &lt;action android:name="com.example.android.apis.app.IRemoteService" /&gt;
        &lt;action android:name="com.example.android.apis.app.ISecondary" /&gt;
        &lt;action android:name="com.example.android.apis.app.REMOTE_SERVICE" /&gt;
    &lt;/intent-filter&gt;
&lt;/service&gt;
</pre>


<footer>
    <a href="index.html" id="back-home">首页</a>
    <a href="index.html" id="back-about">关于</a>
    <a href="http://www.163.com/" id="back-email">Email</a>
</footer>

</article>
</div>

</body>
</html>
