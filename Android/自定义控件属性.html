<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>自定义控件属性</title>
    <!--格式化代码的特效脚本-->
    <script type="text/javascript" src="scripts/shCore.js"></script>
    <script type="text/javascript" src="scripts/shBrushBash.js"></script>
    <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCss.js"></script>
    <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
    <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
    <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
    <script type="text/javascript" src="scripts/shBrushJava.js"></script>
    <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
    <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
    <script type="text/javascript" src="scripts/shBrushPython.js"></script>
    <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
    <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
    <script type="text/javascript" src="scripts/shBrushScala.js"></script>
    <script type="text/javascript" src="scripts/shBrushSql.js"></script>
    <script type="text/javascript" src="scripts/shBrushVb.js"></script>
    <script type="text/javascript" src="scripts/shBrushXml.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/shCoreZenki.css"/>
    <link type="text/css" rel="stylesheet" href="styles/shThemeZenki.css"/>
    <script type="text/javascript">
        SyntaxHighlighter.all();
    </script>
    <link rel="Stylesheet" type="text/css" href="../css_style/style_zenki.css">

</head>

<body>
<div id="wrapper">
<header>

<div id="logo">
</div>

<nav>
    <ul>
        <!--<li class="first"><a href="diary/diary.html">日记</a></li>-->
     </ul>
</nav>
</header>

<article>

<!-- wrap the vimwiki html -->

<h1 id="toc_1">自定义控件属性</h1>

<div class="toc">
<ul>
<li><a href="#toc_1">自定义控件属性</a>
<ul>
<li><a href="#toc_1.1">XML定义</a>
<ul>
<li><a href="#toc_1.1.1">声明自定义属性的名称</a>
<li><a href="#toc_1.1.2">定义自定义属性值</a>
<li><a href="#toc_1.1.3">通过定义风格文件指定属性值（可选）</a>
</ul>
<li><a href="#toc_1.2">如何解析自定义属性</a>
<ul>
<li><a href="#toc_1.2.1">方法一 - 布局XML中指定</a>
<li><a href="#toc_1.2.2">方法二 - 通过指定主题风格</a>
<li><a href="#toc_1.2.3">方法三 - 静态设置属性值</a>
<li><a href="#toc_1.2.4">方法四 - 动态解析资源</a>
<li><a href="#toc_1.2.5">方法五 - 动态解析资源</a>
</ul>
</ul>
<li><a href="#toc_2">主题、风格和属性</a>
<ul>
<li><a href="#toc_2.1">属性</a>
<li><a href="#toc_2.2">风格</a>
<li><a href="#toc_2.3">主题</a>
</ul>
</ul>
</div>

<h2 id="toc_1.1">XML定义</h2>
<h3 id="toc_1.1.1">声明自定义属性的名称</h3>
<ul>
<li>
在values/attrs.xml中添加自定义属性的名称。

<li>
<code>MyView</code>是自定义控件的类名。
<pre class="brush:xml">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;resources&gt;
    &lt;!-- 它是一个指向style标签的引用，可在主题中定义该属性 --&gt;
    &lt;attr name="myViewStyle" format="reference" /&gt;
    
    &lt;!-- MyView是自定义控件类名 --&gt;
    &lt;declare-styleable name="MyView"&gt;
        &lt;attr name="TextAttrExt" format="reference|string"&gt;&lt;/attr&gt;
        &lt;attr name="OrientalAttrExt"&gt;
            &lt;enum name="Horizontal" value="1"&gt;&lt;/enum&gt;
            &lt;enum name="Vertical" value="0"&gt;&lt;/enum&gt;
        &lt;/attr&gt;
        &lt;attr name="BackgroundAttrExt" format="reference|color"&gt;&lt;/attr&gt;
    &lt;/declare-styleable&gt;
&lt;/resources&gt;
</pre>

</ul>

<h3 id="toc_1.1.2">定义自定义属性值</h3>
<ul>
<li>
在定义控件的布局文件layout/main.xml中，添加自定义属性的值。

<ul>
<li>
首先要定一个XML的名字空间：xmlns:zenki="<a href="http://schemas.android.com/apk/res-auto"">http://schemas.android.com/apk/res-auto"</a>

<li>
每个自定义属性前都需要添加名字空间的标识。
<pre class="brush:xml">
&lt;RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
    &lt;!-- res-auto可改成res/package_name的形式 --&gt;
    xmlns:zenki="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent" &gt;

    &lt;com.example.testcustomattrbuite.MyView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        &lt;!-- 以下是自定义属性 --&gt;
        zenki:TextAttrExt="@string/hello_world" 
        zenki:OrientalAttrExt="Horizontal"
        zenki:BackgroundAttrExt="@drawable/my_view_background"/&gt;

&lt;/RelativeLayout&gt;
</pre>

</ul>
</ul>

<h3 id="toc_1.1.3">通过定义风格文件指定属性值（可选）</h3>
<ul>
<li>
在values/styles.xml中指定控件的默认属性值，名称定义为MyViewDefaultStyle。

<li>
解析属性值时，将R.style.MyViewDefaultStyle作为默认的风格资源，参见下面的<code>解析自定义属性-方法一</code>。
<pre class="brush:xml">
&lt;resources&gt;
    &lt;!-- 这里的风格可以继承自系统风格 --&gt;
    &lt;style name="MyViewDefaultStyle" parent="@android:style/Widget.Button"&gt;
        &lt;item name="TextAttrExt"&gt;@string/hello_world&lt;/item&gt;
        &lt;item name="OrientalAttrExt"&gt;Horizontal&lt;/item&gt;
        &lt;item name="BackgroundAttrExt"&gt;@drawable/my_view_background&lt;/item&gt; 
    &lt;/style&gt;

    &lt;style name="AppThemeDark" parent="@android:style/Theme.Black"&gt;
		&lt;!-- myViewStyle是attrs.xml中定义的一个风格标签的引用 --&gt;
		&lt;item name="myViewStyle"&gt;@style/MyViewDefaultStyle&lt;/item&gt;
		
		&lt;!-- 此处还可包含其他的风格定义 --&gt;
	&lt;/style&gt;
&lt;/resources&gt;
</pre>

</ul>

<h2 id="toc_1.2">如何解析自定义属性</h2>
<h3 id="toc_1.2.1">方法一 - 布局XML中指定</h3>
<pre class="brush:xml">
&lt;MyView
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    style="@style/ASSwitchButton"
&lt;/MyView&gt;
</pre>

<h3 id="toc_1.2.2">方法二 - 通过指定主题风格</h3>
<ul>
<li>
在构造函数中指定默认的风格。
<pre class="brush:java">
public MyText(Context context, AttributeSet attrs) {
    // 首先在attrs.xml文件中定义属性值，它是一个风格的引用，
    // 其次，在styles.xml中定义一组自定义风格
    // 最后，在主题中指定myViewStyle的引用值
	this(context, attrs, R.attr.myViewStyle);
}
</pre>

</ul>

<h3 id="toc_1.2.3">方法三 - 静态设置属性值</h3>
<ul>
<li>
该方法需要配置一个默认的style来描述控件的属性值，参见上面一节<code>通过定义风格文件指定属性值</code>的内容。

<li>
obtainStyledAttributes方法中第三个参数即为加载的style资源文件ID。

<li>
直接根据R文件中的属性ID获取属性值。
<pre class="brush:java">
private void getAttrMethod(AttributeSet attrs, int defStyle) {
    // 需要加载默认属性的风格ID：R.style.MyViewDefaultStyle
    TypedArray typeArray = getContext().obtainStyledAttributes(attrs,
            R.styleable.MyView, R.attr.myViewStyle, R.style.MyViewDefaultStyle);
            
    mText = typeArray.getText(R.styleable.MyView_TextAttrExt).toString();
    mOriental = typeArray.getInt(R.styleable.MyView_OrientalAttrExt, 0);
    mBitmap = drawableToBitmap(typeArray.getDrawable(R.styleable.MyView_BackgroundAttrExt));
    
    typeArray.recycle();
}
</pre>

</ul>

<h3 id="toc_1.2.4">方法四 - 动态解析资源</h3>
<ul>
<li>
一般分两步读取自定义属性：

<ul>
<li>
首先读取attrs.xml中定义的属性名称，编译后属性的ID命名规则是<code>属性风格名称_属性名称</code>，例如MyView_TextAttrExt。

<li>
Resource对象根据属性名称在R文件中的定义——即属性ID，查找对应的资源ID，获取资源。
<pre class="brush:java">
private void getAttrMethod(AttributeSet attrs, int defStyle) {
    int resourceId = -1;
    
    // 获取TypedArray对象
    TypedArray typeArray = getContext().obtainStyledAttributes(attrs, R.styleable.MyView, defStyle, 0);
    
    // 获取属性值的数量
    int count = typeArray.getIndexCount();
    for (int i = 0; i &lt; count; i++) {
        // 获取属性ID
        int attr = typeArray.getIndex(i);
        // 获取资源ID
        resourceId = typeArray.getResourceId(attr, 0);
        
        switch (attr) {
        case R.styleable.MyView_TextAttrExt:
            mText = typeArray.getResources().getText(resourceId).toString();
            break;
        case R.styleable.MyView_OrientalAttrExt:
            mOriental = typeArray.getInt(attr, 0);
            break;
        case R.styleable.MyView_BackgroundAttrExt:
            mBitmap = BitmapFactory.decodeResource(typeArray.getResources(), resourceId);
            break;

        default:
            break;
        }
    }

    typeArray.recycle();
}
</pre>

</ul>
</ul>

<h3 id="toc_1.2.5">方法五 - 动态解析资源</h3>
<ul>
<li>
使用构造函数传递的<code>AttributeSet</code>对象获取属性列表。
<pre class="brush:java">
private void getAttrMethod(Context context, AttributeSet attrs) {
    // 获取属性个数
    int count = attrs.getAttributeCount();
    String name;
    for (int i = 0; i &lt; count; i++) {
        // 按照序号，获取属性名字
        name = attrs.getAttributeName(i);
        if (name.equals("text")) {
            // 调用getAttributeValue方法获取资源ID
            int resouceId = Integer.valueOf(attrs.getAttributeValue(i).substring(1));
            if (resouceId &gt; 0) {
                // 根据资源ID获取属性值
                mTextContent = context.getResources().getText(resouceId).toString();
            }
        }
    }
}
</pre>

</ul>

<h1 id="toc_2">主题、风格和属性</h1>
<h2 id="toc_2.1">属性</h2>
<ul>
<li>
属性定义是一种可通过XML文件给控件定义特征的行为，通常定义在values/attrs.xml中。

<li>
通过以下格式声明属性：
<pre class="brush:xml">
&lt;!-- 作为主题的item属性 --&gt;
&lt;attr name="myViewStyleInTheme" format="reference" /&gt;

&lt;!-- 作为自定义控件的属性 --&gt;
&lt;declare-styleable name="MyView"&gt;
    &lt;attr name="background" format="reference" /&gt;
&lt;/declare-styleable&gt;
</pre>

</ul>

<ul>
<li>
通过以下格式使用属性：
<pre class="brush:xml">
&lt;MyView
    &lt;!-- 注意命名空间的定义 --&gt;
    xmlns:myview="http://schemas.android.com/apk/res-auto"
    myview:background="@drawable/background" /&gt;
</pre>

</ul>

<h2 id="toc_2.2">风格</h2>
<ul>
<li>
风格是一组属性值定义的集合，通常定义在values/styles.xml中。

<li>
通过以下格式定义风格：
<pre class="brush:xml">
&lt;style name="MyViewDefaultStyle"&gt;
    &lt;item name="TextAttrExt"&gt;@string/hello_world&lt;/item&gt;
    &lt;item name="OrientalAttrExt"&gt;Horizontal&lt;/item&gt;
    &lt;item name="BackgroundAttrExt"&gt;@drawable/my_view_background&lt;/item&gt; 
&lt;/style&gt;
</pre>

</ul>

<ul>
<li>
通过主题引用风格：
<pre class="brush:xml">
&lt;style name="AppTheme" parent="AppBaseTheme"&gt;
    &lt;item name="myViewStyle"&gt;@style/MyViewDefaultStyle&lt;/item&gt;
&lt;/style&gt;
</pre>

</ul>

<ul>
<li>
通过代码引用风格：
<pre class="brush:java">
// 在构造方法中引用
public MyText(Context context, AttributeSet attrs) {
    // 第三个参数为attrs.xml文件中定义的属性值，它是一个风格的引用，
    // 该属性必须在主题中定义它的引用值
	this(context, attrs, R.attr.myViewStyle);
}

public MyText(Context context, AttributeSet attrs, int defStyle) {
    // R.style.MyViewDefaultStyle为风格在R中的定义
    TypedArray typeArray = getContext().obtainStyledAttributes(attrs,
				R.styleable.MyView, defStyle, R.style.MyViewDefaultStyle);
}
</pre>

</ul>

<h2 id="toc_2.3">主题</h2>
<ul>
<li>
主题是一组风格的集合，通常定义在values/themes.xml中。

<li>
主题也是一种风格的定义，只是它通过指定的属性值，包含了多个风格。

<li>
通过以下格式定义主题：
<pre class="brush:xml">
&lt;style name="AppTheme" parent="AppBaseTheme"&gt;
    &lt;!-- myViewStyle是一个attr属性 --&gt;
    &lt;item name="myViewStyle"&gt;@style/MyViewDefaultStyle&lt;/item&gt;
    &lt;item ... 其他风格定义... /&gt;
&lt;/style&gt;
</pre>

</ul>


<footer>
    <a href="http://zenki2001cn.github.com/Wiki" id="back-home">首页</a>
    <a href="index.html" id="back-about">关于</a>
    <a href="zenki2001cn@163.com" id="back-email">Email</a>
</footer>

</article>
</div>

</body>
</html>
