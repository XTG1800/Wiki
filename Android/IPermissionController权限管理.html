<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>IPermissionController权限管理</title>
    <!--格式化代码的特效脚本-->
    <script type="text/javascript" src="scripts/shCore.js"></script>
    <script type="text/javascript" src="scripts/shBrushBash.js"></script>
    <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCss.js"></script>
    <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
    <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
    <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
    <script type="text/javascript" src="scripts/shBrushJava.js"></script>
    <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
    <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
    <script type="text/javascript" src="scripts/shBrushPython.js"></script>
    <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
    <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
    <script type="text/javascript" src="scripts/shBrushScala.js"></script>
    <script type="text/javascript" src="scripts/shBrushSql.js"></script>
    <script type="text/javascript" src="scripts/shBrushVb.js"></script>
    <script type="text/javascript" src="scripts/shBrushXml.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/shCoreZenki.css"/>
    <link type="text/css" rel="stylesheet" href="styles/shThemeZenki.css"/>
    <script type="text/javascript">
        SyntaxHighlighter.all();
    </script>
	<link type="text/css" rel="stylesheet" href="css_style/style_zenki.css"/>

</head>

<body>
<div id="wrapper">
<header>

<div id="logo">
</div>

<nav>
    <ul>
        <!--<li class="first"><a href="diary/diary.html">日记</a></li>-->
     </ul>
</nav>
</header>

<article>


<h1 id="toc_1">IPermissionController权限管理</h1>

<div class="toc">
<ul>
<li><a href="#toc_1">IPermissionController权限管理</a></li>
<ul>
<li><a href="#toc_1.1">权限管理的三个要素</a></li>
<li><a href="#toc_1.2">基于Binder框架的实现</a></li>
<li><a href="#toc_1.3">要点分析</a></li>
<li><a href="#toc_1.4">IPermissionController.h</a></li>
<ul>
<li><a href="#toc_1.4.1">IPermissionController</a></li>
<li><a href="#toc_1.4.2">BnPermissionController</a></li>
</ul>
<li><a href="#toc_1.5">IPermissionController.cpp</a></li>
<ul>
<li><a href="#toc_1.5.1">IMPLEMENT_META_INTERFACE</a></li>
<li><a href="#toc_1.5.2">BpPermissionController</a></li>
<li><a href="#toc_1.5.3">BnPermissionController::onTransact</a></li>
</ul>
<li><a href="#toc_1.6">IServiceManager.h</a></li>
<ul>
<li><a href="#toc_1.6.1">checkPermission声明</a></li>
</ul>
<li><a href="#toc_1.7">IServiceManager.cpp</a></li>
<ul>
<li><a href="#toc_1.7.1">_permission</a></li>
<li><a href="#toc_1.7.2">checkCallingPermission</a></li>
<li><a href="#toc_1.7.3">checkCallingPermission</a></li>
<li><a href="#toc_1.7.4">checkPermission</a></li>
</ul>
<li><a href="#toc_1.8">AudioPolicyService.cpp</a></li>
<ul>
<li><a href="#toc_1.8.1">checkPermission</a></li>
<li><a href="#toc_1.8.2">AudioPolicyService::setRingerMode</a></li>
</ul>
</ul>
</ul>
</div>

<h2 id="toc_1.1">权限管理的三个要素</h2>
<ul>
<li>
权限名称
</li>
<li>
进程ID
</li>
<li>
用户ID
</li>
</ul>

<h2 id="toc_1.2">基于Binder框架的实现</h2>
<ul>
<li>
权限管理其实也是基于Binder框架来实现的，首先定义了IPermissionController接口类，它继承于IInterface，并声明了一个虚函数<code>checkPermission</code>。
</li>
<li>
<code>BnPermissionController</code>和<code>BpPermissionController</code>分别是权限管理的服务端和代理端。
</li>
<li>
获取代理端对象BpPermissionController的入口函数在<code>IServiceManager.h</code>中定义，并在<code>IServiceManager.cpp</code>中实现，它们都属于名字空间——android。
</li>
<li>
需要注意的是：IServiceManager.cpp中实现的checkPermission()方法并不是IPermissionController中的checkPermission()，IPermissionController中定义的checkPermission()方法分别在BnPermissionController和BpPermissionController中实现。目前BnPermissionController中的具体实现还没有找到。
</li>
</ul>

<h2 id="toc_1.3">要点分析</h2>
<ul>
<li>
我们用AudioPolicyService的例子来分析权限认证的流程，首先查看AudioPolicyService.cpp的代码。
</li>
<li>
其中定义了一个静态方法checkPermission()，它会通过IPCThreadState来获取调用进程的ID，如果是当前服务进程，那么就返回true，否则会调用IServiceManager.cpp中的checkCallingPermission()方法，该方法最终会通过代理端——服务端模式的流程来检查权限。(结合前面章节的内容)
</li>
<li>
AudioPolicyService在调用setRingerMode()时会检查是否符合权限，否则返回PERMISSION_DENIED。(其他方法也会调用checkPermission)
</li>
</ul>

<h2 id="toc_1.4">IPermissionController.h</h2>
<h3 id="toc_1.4.1">IPermissionController</h3>
<pre class="brush:c++">
class IPermissionController : public IInterface
{
public:
    DECLARE_META_INTERFACE(PermissionController);

    virtual bool checkPermission(const String16&amp; permission,
                                 int32_t pid, int32_t uid) = 0;
    
    enum {
        CHECK_PERMISSION_TRANSACTION = IBinder::FIRST_CALL_TRANSACTION
    };
};
</pre>

<h3 id="toc_1.4.2">BnPermissionController</h3>
<pre class="brush:c++">
class BnPermissionController : public BnInterface&lt;IPermissionController&gt;
{
public:
    virtual status_t onTransact( uint32_t code,
                                 const Parcel&amp; data,
                                 Parcel* reply,
                                 uint32_t flags = 0);
};
</pre>

<h2 id="toc_1.5">IPermissionController.cpp</h2>
<h3 id="toc_1.5.1">IMPLEMENT_META_INTERFACE</h3>
<pre class="brush:c++">
IMPLEMENT_META_INTERFACE(PermissionController, "android.os.IPermissionController");
</pre>

<h3 id="toc_1.5.2">BpPermissionController</h3>
<pre class="brush:c++">
class BpPermissionController : public BpInterface&lt;IPermissionController&gt;
{
public:
    BpPermissionController(const sp&lt;IBinder&gt;&amp; impl)
        : BpInterface&lt;IPermissionController&gt;(impl)
    {
    }

    virtual bool checkPermission(const String16&amp; permission, int32_t pid, int32_t uid)
    {
        Parcel data, reply;
        data.writeInterfaceToken(IPermissionController::getInterfaceDescriptor());
        data.writeString16(permission);
        data.writeInt32(pid);
        data.writeInt32(uid);
        remote()-&gt;transact(CHECK_PERMISSION_TRANSACTION, data, &amp;reply);
        // fail on exception
        if (reply.readExceptionCode() != 0) return 0;
        return reply.readInt32() != 0;
    }
};
</pre>

<h3 id="toc_1.5.3">BnPermissionController::onTransact</h3>
<pre class="brush:c++">
status_t BnPermissionController::onTransact(
    uint32_t code, const Parcel&amp; data, Parcel* reply, uint32_t flags)
{
    switch(code) {
        case CHECK_PERMISSION_TRANSACTION: {
            CHECK_INTERFACE(IPermissionController, data, reply);
            String16 permission = data.readString16();
            int32_t pid = data.readInt32();
            int32_t uid = data.readInt32();
            bool res = checkPermission(permission, pid, uid);
            reply-&gt;writeNoException();
            reply-&gt;writeInt32(res ? 1 : 0);
            return NO_ERROR;
        } break;
        default:
            return BBinder::onTransact(code, data, reply, flags);
    }
}
</pre>

<h2 id="toc_1.6">IServiceManager.h</h2>
<h3 id="toc_1.6.1">checkPermission声明</h3>
<pre class="brush:c++">
bool checkCallingPermission(const String16&amp; permission);
bool checkCallingPermission(const String16&amp; permission,
                            int32_t* outPid, int32_t* outUid);
bool checkPermission(const String16&amp; permission, pid_t pid, uid_t uid);
</pre>

<h2 id="toc_1.7">IServiceManager.cpp</h2>
<h3 id="toc_1.7.1">_permission</h3>
<pre class="brush:c++">
static String16 _permission("permission");
</pre>

<h3 id="toc_1.7.2">checkCallingPermission</h3>
<pre class="brush:c++">
bool checkCallingPermission(const String16&amp; permission)
{
    return checkCallingPermission(permission, NULL, NULL);
}
</pre>

<h3 id="toc_1.7.3">checkCallingPermission</h3>
<pre class="brush:c++">
bool checkCallingPermission(const String16&amp; permission, int32_t* outPid, int32_t* outUid)
{
    IPCThreadState* ipcState = IPCThreadState::self();
    pid_t pid = ipcState-&gt;getCallingPid();
    uid_t uid = ipcState-&gt;getCallingUid();
    if (outPid) *outPid = pid;
    if (outUid) *outUid = uid;
    return checkPermission(permission, pid, uid);
}
</pre>

<h3 id="toc_1.7.4">checkPermission</h3>
<pre class="brush:c++">
bool checkPermission(const String16&amp; permission, pid_t pid, uid_t uid)
{
    sp&lt;IPermissionController&gt; pc;
    gDefaultServiceManagerLock.lock();
    pc = gPermissionController;
    gDefaultServiceManagerLock.unlock();
    
    int64_t startTime = 0;

    while (true) {
        // 如果有BpPermissionController对象，则通过代理对象查询是否符合权限
        if (pc != NULL) {
            bool res = pc-&gt;checkPermission(permission, pid, uid);
            if (res) {
                if (startTime != 0) {
                }
                return res;
            }
            
            // Is this a permission failure, or did the controller go away?
            if (pc-&gt;asBinder()-&gt;isBinderAlive()) {
                return false;
            }
            
            // Object is dead!
            gDefaultServiceManagerLock.lock();
            if (gPermissionController == pc) {
                gPermissionController = NULL;
            }
            gDefaultServiceManagerLock.unlock();
        }
    
        // 第一次从ServiceManager获取permission的IBinder
        sp&lt;IBinder&gt; binder = defaultServiceManager()-&gt;checkService(_permission);
        if (binder == NULL) {
            // Wait for the permission controller to come back...
            if (startTime == 0) {
                startTime = uptimeMillis();
            }
            sleep(1);
        } else {
            // 转换成BpPermissionController对象
            pc = interface_cast&lt;IPermissionController&gt;(binder);
            // Install the new permission controller, and try again.        
            gDefaultServiceManagerLock.lock();
            gPermissionController = pc;
            gDefaultServiceManagerLock.unlock();
        }
    }
}
</pre>

<h2 id="toc_1.8">AudioPolicyService.cpp</h2>
<h3 id="toc_1.8.1">checkPermission</h3>
<pre class="brush:c++">
static bool checkPermission() {
#ifndef HAVE_ANDROID_OS
    return true;
#endif
    if (getpid() == IPCThreadState::self()-&gt;getCallingPid()) return true;
    bool ok = checkCallingPermission(String16("android.permission.MODIFY_AUDIO_SETTINGS"));
    if (!ok) LOGE("Request requires android.permission.MODIFY_AUDIO_SETTINGS");
    return ok;
}
</pre>

<h3 id="toc_1.8.2">AudioPolicyService::setRingerMode</h3>
<pre class="brush:c++">
status_t AudioPolicyService::setRingerMode(uint32_t mode, uint32_t mask)
{
    if (mpPolicyManager == NULL) {
        return NO_INIT;
    }
    if (!checkPermission()) {
        return PERMISSION_DENIED;
    }

    mpPolicyManager-&gt;setRingerMode(mode, mask);
    return NO_ERROR;
}
</pre>
<footer>
    <a href="index.html" id="back-home">首页</a>
    <a href="index.html" id="back-about">关于</a>
    <a href="http://www.163.com/" id="back-email">Email</a>
</footer>

</article>
</div>

<!--<script type="text/javascript">-->
<!--var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");-->
<!--document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));-->
<!--</script>-->
<!--<script type="text/javascript">-->
<!--try {-->
<!--var pageTracker = _gat._getTracker("UA-15922433-1");-->
<!--pageTracker._trackPageview();-->
<!--} catch(err) {}-->
<!--</script>-->

</body>
</html>
