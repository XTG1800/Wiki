<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Keyboard按键映射</title>
    <!--格式化代码的特效脚本-->
    <script type="text/javascript" src="scripts/shCore.js"></script>
    <script type="text/javascript" src="scripts/shBrushBash.js"></script>
    <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCss.js"></script>
    <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
    <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
    <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
    <script type="text/javascript" src="scripts/shBrushJava.js"></script>
    <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
    <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
    <script type="text/javascript" src="scripts/shBrushPython.js"></script>
    <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
    <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
    <script type="text/javascript" src="scripts/shBrushScala.js"></script>
    <script type="text/javascript" src="scripts/shBrushSql.js"></script>
    <script type="text/javascript" src="scripts/shBrushVb.js"></script>
    <script type="text/javascript" src="scripts/shBrushXml.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/shCoreZenki.css"/>
    <link type="text/css" rel="stylesheet" href="styles/shThemeZenki.css"/>
    <script type="text/javascript">
        SyntaxHighlighter.all();
    </script>
	<link type="text/css" rel="stylesheet" href="css_style/style_zenki.css"/>

</head>

<body>
<div id="wrapper">
<header>

<div id="logo">
</div>

<nav>
    <ul>
        <!--<li class="first"><a href="diary/diary.html">日记</a></li>-->
     </ul>
</nav>
</header>

<article>


<h1 id="toc_1">Keyboard按键映射</h1>

<div class="toc">
<ul>
<li><a href="#toc_1">Keyboard按键映射</a></li>
<ul>
<li><a href="#toc_1.1">keyboard输入系统概述</a></li>
<li><a href="#toc_1.2">keyboard输入的流程</a></li>
<li><a href="#toc_1.3">key的映射</a></li>
<ul>
<li><a href="#toc_1.3.1">Key Layout Map</a></li>
<ul>
<li><a href="#toc_1.3.1.1">.kl文件格式描述</a></li>
<li><a href="#toc_1.3.1.2">.kl文件示例</a></li>
</ul>
<li><a href="#toc_1.3.2">Key Character Map</a></li>
<ul>
<li><a href="#toc_1.3.2.1">.kcm文件格式描述</a></li>
<li><a href="#toc_1.3.2.2">.kcm文件示例</a></li>
</ul>
</ul>
<li><a href="#toc_1.4">映射文件路径</a></li>
</ul>
</ul>
</div>

<h2 id="toc_1.1">keyboard输入系统概述</h2>
<pre class="brush:text">
    keyboard输入系统使用/dev/input/event0作为设备节点，驱动层将事件传递给framework的监听线程，并向上传递给Application。
本文介绍有关Android对于keyboard按键的映射、底层事件处理及Java层的事件响应。我们的入口从按键的响应流程开始。
</pre>

<h2 id="toc_1.2">keyboard输入的流程</h2>
<ul>
<li>
1.驱动层输出：首先驱动层接收到keyboard按键响应，将对应的按键作为scancode输出。
</li>
<li>
2.scancode转换keycode：窗口管理器接收到来自驱动的scancode后，根据映射文件的定义，需要将scancode转换成keycode。例如将16转换成Q。
</li>
<li>
3.发送scancode和keycode：窗口管理器将scancode和keycode同时发送给应用程序，由应用程序决定如何处理按键响应。
</li>
</ul>

<h2 id="toc_1.3">key的映射</h2>
<pre class="brush:text">
    根据以上的描述，我们知道了scancode和keycode的概念。Android提供了两个映射文件
分别映射scancode和keycode。
    *.kl文件用来映射scancode到keycode。*.kcm文件用来映射keycode到具体的字符。
下面将详细解析这两个文件。
</pre>

<h3 id="toc_1.3.1">Key Layout Map</h3>
<pre class="brush:text">
    *.kl文件用来映射scancode到keycode，通常称之为“Key Layout Map”，它的目录为
/system/usr/keylayout/或/data/usr/keylayout。默认的文件名为/system/usr/keylayout/qwerty.kl。
可以设置系统属性android.keylayout.*来指定文件路径。
</pre>

<h4 id="toc_1.3.1.1">.kl文件格式描述</h4>
<ul>
<li>
注释：#开头为注释。
</li>
<li>
空行：所有空行被忽略。
</li>
<li>
Key定义：<code>key SCANCODE KEYCODE [FLAGS...]</code>
</li>
<ul>
<li>
key为关键字
</li>
<li>
SCANCODE为数字
</li>
<li>
KEYCODE为映射的字符
</li>
</ul>
</ul>

<h4 id="toc_1.3.1.2">.kl文件示例</h4>
<pre class="brush:bash">
# Copyright 2007 The Android Open Source Project
#key scancode keycode flags
key 158   BACK              WAKE_DROPPED
key 230   SOFT_RIGHT        WAKE
key 60    SOFT_RIGHT        WAKE
key 107   ENDCALL           WAKE_DROPPED
key 62    ENDCALL           WAKE_DROPPED
key 229   MENU              WAKE_DROPPED
key 59    MENU              WAKE_DROPPED
key 228   POUND
key 227   STAR

key 16    Q
key 17    W
key 18    E
key 19    R
key 20    T
key 21    Y
key 22    U
key 23    I
key 24    O
key 25    P
</pre>

<h3 id="toc_1.3.2">Key Character Map</h3>
<pre class="brush:text">
    *.kcm文件用来映射keycode到字符，通常称之为“Key Character Map”。它的目录为
/system/usr/keychars或/data/usr/keychars。默认的文件名为/system/usr/keychar/qwerty.kl。
可以设置系统属性android.keychar.*来指定文件路径。
</pre>

<h4 id="toc_1.3.2.1">.kcm文件格式描述</h4>
<ul>
<li>
注释：#开头为注释。
</li>
<li>
空行：所有空行被忽略。
</li>
<li>
Key定义：<code>keycode CHARACTER [...]</code>
</li>
<ul>
<li>
keycode为scancode对应的keycode
</li>
<li>
CHARACTER为映射的字符
</li>
</ul>
</ul>
 
<h4 id="toc_1.3.2.2">.kcm文件示例</h4>
<pre class="brush:bash">
# Copyright 2007 The Android Open Source Project

[type=QWERTY]

# keycode   base    caps    fn      caps_fn number  display_label

A           'a'     'A'     '%'     0x00    '%'     'A'
B           'b'     'B'     '='     0x00    '='     'B'
C           'c'     'C'     '8'     0x00E7  '8'     'C'
D           'd'     'D'     '5'     0x00    '5'     'D'
E           'e'     'E'     '2'     0x0301  '2'     'E'
F           'f'     'F'     '6'     0x00A5  '6'     'F'
G           'g'     'G'     '-'     '_'     '-'     'G'
H           'h'     'H'     '['     '{'     '['     'H'
I           'i'     'I'     '$'     0x0302  '$'     'I'

COMMA       ','     ';'     ';'     '|'     ','     ','
PERIOD      '.'     ':'     ':'     0x2026  '.'     '.'
AT          '@'     '0'     '0'     0x2022  '0'     '@'
SLASH       '/'     '?'     '?'     '\'     '/'     '/'
</pre>

<h2 id="toc_1.4">映射文件路径</h2>
<ul>
<li>
可通过系统属性来设置key映射文件的路径。
</li>
</ul>

<pre class="brush:bash">
android.keylayout.partnerxx_keypad = /system/usr/keylayout/partnerxx_keypad.kl
android.keychar.partnerxx_keypad = /system/usr/keychars/partnerxx.kcm
</pre>
<footer>
    <a href="index.html" id="back-home">首页</a>
    <a href="index.html" id="back-about">关于</a>
    <a href="http://www.163.com/" id="back-email">Email</a>
</footer>

</article>
</div>

<!--<script type="text/javascript">-->
<!--var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");-->
<!--document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));-->
<!--</script>-->
<!--<script type="text/javascript">-->
<!--try {-->
<!--var pageTracker = _gat._getTracker("UA-15922433-1");-->
<!--pageTracker._trackPageview();-->
<!--} catch(err) {}-->
<!--</script>-->

</body>
</html>
