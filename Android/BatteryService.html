<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>BatteryService</title>
    <!--格式化代码的特效脚本-->
    <script type="text/javascript" src="scripts/shCore.js"></script>
    <script type="text/javascript" src="scripts/shBrushBash.js"></script>
    <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCss.js"></script>
    <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
    <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
    <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
    <script type="text/javascript" src="scripts/shBrushJava.js"></script>
    <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
    <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
    <script type="text/javascript" src="scripts/shBrushPython.js"></script>
    <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
    <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
    <script type="text/javascript" src="scripts/shBrushScala.js"></script>
    <script type="text/javascript" src="scripts/shBrushSql.js"></script>
    <script type="text/javascript" src="scripts/shBrushVb.js"></script>
    <script type="text/javascript" src="scripts/shBrushXml.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/shCoreZenki.css"/>
    <link type="text/css" rel="stylesheet" href="styles/shThemeZenki.css"/>
    <script type="text/javascript">
        SyntaxHighlighter.all();
    </script>
	<link type="text/css" rel="stylesheet" href="css_style/style_zenki.css"/>

</head>

<body>
<div id="wrapper">
<header>

<div id="logo">
</div>

<nav>
    <ul>
        <!--<li class="first"><a href="diary/diary.html">日记</a></li>-->
     </ul>
</nav>
</header>

<article>


<h1 id="toc_1">BatteryService分析</h1>

<div class="toc">
<ul>
<li><a href="#toc_1">BatteryService分析</a></li>
<ul>
<li><a href="#toc_1.1">代码分析</a></li>
<ul>
<li><a href="#toc_1.1.1">定义用于JNI返回的变量</a></li>
<li><a href="#toc_1.1.2">构造方法</a></li>
<li><a href="#toc_1.1.3">更新数据</a></li>
<li><a href="#toc_1.1.4">数据传送</a></li>
</ul>
</ul>
</ul>
</div>

<h2 id="toc_1.1">代码分析</h2>
<h3 id="toc_1.1.1">定义用于JNI返回的变量</h3>
<pre class="brush:java">
private boolean mAcOnline;
private boolean mUsbOnline;
private int mBatteryStatus;
private int mBatteryHealth;
private boolean mBatteryPresent;
private int mBatteryLevel;
private int mBatteryVoltage;
private int mBatteryTemperature;
private String mBatteryTechnology;
private boolean mBatteryLevelCritical;
</pre>

<h3 id="toc_1.1.2">构造方法</h3>
<pre class="brush:java">
public BatteryService(Context context) {
    mContext = context;
    mBatteryStats = BatteryStatsService.getService();

    mLowBatteryWarningLevel = mContext.getResources().getInteger(
            com.android.internal.R.integer.config_lowBatteryWarningLevel);
    mLowBatteryCloseWarningLevel = mContext.getResources().getInteger(
            com.android.internal.R.integer.config_lowBatteryCloseWarningLevel);

    
    // 添加更新数据对象
    mUEventObserver.startObserving("SUBSYSTEM=power_supply");

    // 更新状态方法
    update();
}
</pre>

<h3 id="toc_1.1.3">更新数据</h3>
<ul>
<li>
update()读取sysfs文件做到同步取得电池信息, 然后根据读到的状态更新BatteryService的成员变量，并广播一个Intent来通知其它关注电源状态的组件。
</li>
<li>
当kernel有power_supply事件上报时，mUEventObserver调用update()函数，然后update()调用native_update从sysfs中读取相关状态。
</li>
</ul>

<pre class="brush:java">
// 注册更新对象
private UEventObserver mUEventObserver = new UEventObserver() {
    @Override
    public void onUEvent(UEventObserver.UEvent event) {
        // 更新状态方法
        update();
    }
};

private native void native_update();

// 更新状态
private synchronized final void update() {
    // 调用JNI的update方法
    native_update();

    ......
    
    if (mBatteryStatus != mLastBatteryStatus ||
            mBatteryHealth != mLastBatteryHealth ||
            mBatteryPresent != mLastBatteryPresent ||
            mBatteryLevel != mLastBatteryLevel ||
            mPlugType != mLastPlugType ||
            mBatteryVoltage != mLastBatteryVoltage ||
            mBatteryTemperature != mLastBatteryTemperature) {

        if (mPlugType != mLastPlugType) {
            if (mLastPlugType == BATTERY_PLUGGED_NONE) {
                // 放电-&gt;充电状态转换
                
            } else if (mPlugType == BATTERY_PLUGGED_NONE) {
                // 充电-&gt;放电状态转换 
                
            }
        }
        
        if (mBatteryLevel != mLastBatteryLevel &amp;&amp; mPlugType == BATTERY_PLUGGED_NONE) {
            // 放电状态下更新电池的等级
            
        }
        if (mBatteryLevelCritical &amp;&amp; !mLastBatteryLevelCritical &amp;&amp;
                mPlugType == BATTERY_PLUGGED_NONE) {
            // 电池电量将要耗尽
            
        }

        ......

        // 通过Intent发送状态
        sendIntent();

        // 通过Intent方式通知电池状态信息
        if (mPlugType != 0 &amp;&amp; mLastPlugType == 0) {
            statusIntent.setAction(Intent.ACTION_POWER_CONNECTED);
            mContext.sendBroadcast(statusIntent);
        }
        else if (mPlugType == 0 &amp;&amp; mLastPlugType != 0) {
            statusIntent.setAction(Intent.ACTION_POWER_DISCONNECTED);
            mContext.sendBroadcast(statusIntent);
        }

        if (sendBatteryLow) {
            mSentLowBatteryBroadcast = true;
            statusIntent.setAction(Intent.ACTION_BATTERY_LOW);
            mContext.sendBroadcast(statusIntent);
        } else if ((mSentLowBatteryBroadcast &amp;&amp; mLastBatteryLevel &gt;= mLowBatteryCloseWarningLevel) ||
                   (mSentLowBatteryBroadcast &amp;&amp; mBatteryStatus == BatteryManager.BATTERY_STATUS_CHARGING)) {
            mSentLowBatteryBroadcast = false;
            statusIntent.setAction(Intent.ACTION_BATTERY_OKAY);
            mContext.sendBroadcast(statusIntent);
        }

        // 更新最后电池信息状态
        mLastBatteryStatus = mBatteryStatus;
        mLastBatteryHealth = mBatteryHealth;
        mLastBatteryPresent = mBatteryPresent;
        mLastBatteryLevel = mBatteryLevel;
        mLastPlugType = mPlugType;
        mLastBatteryVoltage = mBatteryVoltage;
        mLastBatteryTemperature = mBatteryTemperature;
        mLastBatteryLevelCritical = mBatteryLevelCritical;
    }
}
</pre>

<h3 id="toc_1.1.4">数据传送</h3>
<pre class="brush:java">
// 通过发送Intent方式来通知电池状态
private final void sendIntent() {
    //  Pack up the values and broadcast them to everyone
    Intent intent = new Intent(Intent.ACTION_BATTERY_CHANGED);
    intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);
    try {
        mBatteryStats.setOnBattery(mPlugType == BATTERY_PLUGGED_NONE, mBatteryLevel);
    } catch (RemoteException e) {
        // Should never happen.
    }

    int icon = getIcon(mBatteryLevel);

    intent.putExtra(BatteryManager.EXTRA_STATUS, mBatteryStatus);
    intent.putExtra(BatteryManager.EXTRA_HEALTH, mBatteryHealth);
    intent.putExtra(BatteryManager.EXTRA_PRESENT, mBatteryPresent);
    intent.putExtra(BatteryManager.EXTRA_LEVEL, mBatteryLevel);
    intent.putExtra(BatteryManager.EXTRA_SCALE, BATTERY_SCALE);
    intent.putExtra(BatteryManager.EXTRA_ICON_SMALL, icon);
    intent.putExtra(BatteryManager.EXTRA_PLUGGED, mPlugType);
    intent.putExtra(BatteryManager.EXTRA_VOLTAGE, mBatteryVoltage);
    intent.putExtra(BatteryManager.EXTRA_TEMPERATURE, mBatteryTemperature);
    intent.putExtra(BatteryManager.EXTRA_TECHNOLOGY, mBatteryTechnology);

    ActivityManagerNative.broadcastStickyIntent(intent, null);
}
</pre>
<footer>
    <a href="index.html" id="back-home">首页</a>
    <a href="index.html" id="back-about">关于</a>
    <a href="http://www.163.com/" id="back-email">Email</a>
</footer>

</article>
</div>

<!--<script type="text/javascript">-->
<!--var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");-->
<!--document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));-->
<!--</script>-->
<!--<script type="text/javascript">-->
<!--try {-->
<!--var pageTracker = _gat._getTracker("UA-15922433-1");-->
<!--pageTracker._trackPageview();-->
<!--} catch(err) {}-->
<!--</script>-->

</body>
</html>
