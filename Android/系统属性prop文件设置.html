<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>系统属性prop文件设置</title>
    <!--格式化代码的特效脚本-->
    <script type="text/javascript" src="scripts/shCore.js"></script>
    <script type="text/javascript" src="scripts/shBrushBash.js"></script>
    <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCss.js"></script>
    <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
    <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
    <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
    <script type="text/javascript" src="scripts/shBrushJava.js"></script>
    <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
    <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
    <script type="text/javascript" src="scripts/shBrushPython.js"></script>
    <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
    <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
    <script type="text/javascript" src="scripts/shBrushScala.js"></script>
    <script type="text/javascript" src="scripts/shBrushSql.js"></script>
    <script type="text/javascript" src="scripts/shBrushVb.js"></script>
    <script type="text/javascript" src="scripts/shBrushXml.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/shCoreZenki.css"/>
    <link type="text/css" rel="stylesheet" href="styles/shThemeZenki.css"/>
    <script type="text/javascript">
        SyntaxHighlighter.all();
    </script>
    <link rel="Stylesheet" type="text/css" href="../css_style/style_zenki.css">

</head>

<body>
<div id="wrapper">
<header>

<div id="logo">
</div>

<nav>
    <ul>
        <!--<li class="first"><a href="diary/diary.html">日记</a></li>-->
     </ul>
</nav>
</header>

<article>

<!-- wrap the vimwiki html -->

<h1 id="toc_1">系统属性prop文件设置</h1>

<div class="toc">
<ul>
<li><a href="#toc_1">系统属性prop文件设置</a>
<ul>
<li><a href="#toc_1.1">相关文件</a>
<li><a href="#toc_1.2">什么是Android的属性</a>
<li><a href="#toc_1.3">属性文件的位置</a>
<li><a href="#toc_1.4">查看和修改系统属性</a>
<li><a href="#toc_1.5">属性分类</a>
<li><a href="#toc_1.6">如何编译属性信息</a>
<ul>
<li><a href="#toc_1.6.1">buildinfo.sh</a>
<li><a href="#toc_1.6.2">build/core/Makefile</a>
<ul>
<li><a href="#toc_1.6.2.1">default.prop部分</a>
<li><a href="#toc_1.6.2.2">build.prop部分</a>
<li><a href="#toc_1.6.2.3">sdk-build.prop部分</a>
</ul>
</ul>
<li><a href="#toc_1.7">属性标识列表</a>
</ul>
<li><a href="#toc_2">设置和更改属性值的实现</a>
<ul>
<li><a href="#toc_2.1">客户端 — properties.c</a>
<ul>
<li><a href="#toc_2.1.1">property_set</a>
<li><a href="#toc_2.1.2">property_get</a>
</ul>
<li><a href="#toc_2.2">服务端 — property_service.c</a>
<ul>
<li><a href="#toc_2.2.1">property_perms</a>
<li><a href="#toc_2.2.2">property_get</a>
<li><a href="#toc_2.2.3">property_set</a>
</ul>
<li><a href="#toc_2.3">共用库 — system_properties.c</a>
<ul>
<li><a href="#toc_2.3.1">__system_properties_init</a>
<li><a href="#toc_2.3.2">__system_property_find_nth</a>
<li><a href="#toc_2.3.3">__system_property_find</a>
<li><a href="#toc_2.3.4">__system_property_read</a>
<li><a href="#toc_2.3.5">__system_property_get</a>
<li><a href="#toc_2.3.6">__system_property_wait</a>
</ul>
</ul>
</ul>
</div>

<h2 id="toc_1.1">相关文件</h2>
<pre class="brush:text">
// 读写属性的c代码
system/core/init/init.c
system/core/init/property_service.c
system/core/libcutils/properties.c
bionic/libc/bionic/system_properties.c

// 编译环境脚本和mk
build/core/Makefile
build/tools/buildinfo.sh
</pre>

<h2 id="toc_1.2">什么是Android的属性</h2>
<pre class="brush:text">
    每个属性都有一个名称和值，它们都是字符串格式。属性被大量使用在Android系统中，用来记录系统设置或进程之间的信息交换。
属性是在整个系统中全局可见的。每个进程可以get/set属性。在系统初始化时，Android将分配一个共享内存区来存储的属性。这些是
由“init”守护进程完成的，其源代码位于：system/core/init。“init”守护进程将启动一个属性服务。属性服务在“init”守护进程中运行。
每一个客户端想要设置属性时，必须连接属性服务，再向其发送信息。属性服务将会在共享内存区中修改和创建属性。任何客户端想获得
属性信息，可以从共享内存直接读取。这提高了读取性能。
</pre>

<h2 id="toc_1.3">属性文件的位置</h2>
<pre class="brush:text">
当启动属性服务时，将从以下文件中加载默认属性：
/default.prop
/system/build.prop
/system/default.prop
/data/local.prop
属性将会以上述顺序加载，后加载的属性将覆盖原先的值。这些属性加载之后，最后加载的属性会被保持在/data/property中。
</pre>

<h2 id="toc_1.4">查看和修改系统属性</h2>
<pre class="brush:bash">
# 查看属性
# 打开adb模式，输入以下命令
$ adb shell getprop

# 修改属性
$ adb shell setprop key value
</pre>

<h2 id="toc_1.5">属性分类</h2>
<table>
<tr>
<th>
前缀
</th>
<th>
功能
</th>
<th>
备注
</th>
</tr>
<tr>
<td>
ro.*
</td>
<td>
该属性被视为只读属性。一旦设置，属性值不能改变。
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
persist.*
</td>
<td>
当设置这个属性时，其值也将写入/data/property。
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
net.*
</td>
<td>
当设置这个属性时，“net.change”属性将会自动设置，以加入到最后修改的属性名。
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ctrl.start和ctrl.stop
</td>
<td>
用来启动和停止服务。每一项服务必须在/init.rc中定义。系统启动时，与init守护进程将解析init.rc和启动属性服务。一旦收到设置“ ctrl.start ”属性的请求，属性服务将使用该属性值作为服务名找到该服务，启动该服务。这项服务的启动结果将会放入“ init.svc.&lt;服务名&gt;“属性中 。客户端应用程序可以轮询那个属性值，以确定结果。
</td>
<td>
&nbsp;
</td>
</tr>
</table>

<h2 id="toc_1.6">如何编译属性信息</h2>
<ul>
<li>
build/core/Makefile中会调用<code>build/tools/buildinfo.sh</code>脚本来设置属性值

<li>
自定义属性可通过<code>PRODUCT_PROPERTY_OVERRIDES</code>变量设置。(参见<a href="Build环境变量.html">Build环境变量</a>)

</ul>

<h3 id="toc_1.6.1">buildinfo.sh</h3>
<pre class="brush:bash">
#!/bin/bash

echo "# begin build properties"
echo "# autogenerated by buildinfo.sh"

echo "ro.build.id=$BUILD_ID"
echo "ro.build.display.id=$BUILD_DISPLAY_ID"
echo "ro.build.version.incremental=$BUILD_NUMBER"
echo "ro.build.version.sdk=$PLATFORM_SDK_VERSION"
echo "ro.build.version.codename=$PLATFORM_VERSION_CODENAME"
echo "ro.build.version.release=$PLATFORM_VERSION"
echo "ro.build.date=`date`"
echo "ro.build.date.utc=`date +%s`"
echo "ro.build.type=$TARGET_BUILD_TYPE"
echo "ro.build.user=$USER"
echo "ro.build.host=`hostname`"
echo "ro.build.tags=$BUILD_VERSION_TAGS"
echo "ro.product.model=$PRODUCT_MODEL"
echo "ro.product.brand=$PRODUCT_BRAND"
echo "ro.product.name=$PRODUCT_NAME"
echo "ro.product.device=$TARGET_DEVICE"
echo "ro.product.board=$TARGET_BOOTLOADER_BOARD_NAME"
echo "ro.product.cpu.abi=$TARGET_CPU_ABI"
if [ -n "$TARGET_CPU_ABI2" ] ; then
  echo "ro.product.cpu.abi2=$TARGET_CPU_ABI2"
fi
echo "ro.product.manufacturer=$PRODUCT_MANUFACTURER"
echo "ro.product.locale.language=$PRODUCT_DEFAULT_LANGUAGE"
echo "ro.product.locale.region=$PRODUCT_DEFAULT_REGION"
echo "ro.wifi.channels=$PRODUCT_DEFAULT_WIFI_CHANNELS"
echo "ro.board.platform=$TARGET_BOARD_PLATFORM"

echo "# ro.build.product is obsolete; use ro.product.device"
echo "ro.build.product=$TARGET_DEVICE"

echo "# Do not try to parse ro.build.description or .fingerprint"
echo "ro.build.description=$PRIVATE_BUILD_DESC"
echo "ro.build.fingerprint=$BUILD_FINGERPRINT"

echo "# end build properties"
</pre>

<h3 id="toc_1.6.2">build/core/Makefile</h3>
<h4 id="toc_1.6.2.1">default.prop部分</h4>
<pre class="brush:bash">
# 生成/default.prop
INSTALLED_DEFAULT_PROP_TARGET := $(TARGET_ROOT_OUT)/default.prop
ALL_DEFAULT_INSTALLED_MODULES += $(INSTALLED_DEFAULT_PROP_TARGET)
ADDITIONAL_DEFAULT_PROPERTIES := \
	$(call collapse-pairs, $(ADDITIONAL_DEFAULT_PROPERTIES))

$(INSTALLED_DEFAULT_PROP_TARGET):
	@echo Target buildinfo: $@
	@mkdir -p $(dir $@)
	$(hide) echo "#" &gt; $@; \
	        echo "# ADDITIONAL_DEFAULT_PROPERTIES" &gt;&gt; $@; \
	        echo "#" &gt;&gt; $@;
	$(hide) $(foreach line,$(ADDITIONAL_DEFAULT_PROPERTIES), \
		echo "$(line)" &gt;&gt; $@;)
</pre>

<h4 id="toc_1.6.2.2">build.prop部分</h4>
<pre class="brush:bash">
# 生成/system/build.prop
INSTALLED_BUILD_PROP_TARGET := $(TARGET_OUT)/build.prop
ALL_DEFAULT_INSTALLED_MODULES += $(INSTALLED_BUILD_PROP_TARGET)
ADDITIONAL_BUILD_PROPERTIES := \
	$(call collapse-pairs, $(ADDITIONAL_BUILD_PROPERTIES))

# 预置的tags描述
BUILD_VERSION_TAGS := $(BUILD_VERSION_TAGS)
ifeq ($(TARGET_BUILD_TYPE),debug)
  BUILD_VERSION_TAGS += debug
endif

# 为app预设test-keys的tags
BUILD_VERSION_TAGS += test-keys
BUILD_VERSION_TAGS := $(subst $(space),$(comma),$(sort $(BUILD_VERSION_TAGS)))

# 可读的字符串描述
build_desc := $(TARGET_PRODUCT)-$(TARGET_BUILD_VARIANT) $(PLATFORM_VERSION) $(BUILD_ID) $(BUILD_NUMBER) $(BUILD_VERSION_TAGS)
$(INSTALLED_BUILD_PROP_TARGET): PRIVATE_BUILD_DESC := $(build_desc)

# 用于OTA服务器的字符串识别信息
ifeq (,$(strip $(BUILD_FINGERPRINT)))
  BUILD_FINGERPRINT := $(PRODUCT_BRAND)/$(TARGET_PRODUCT)/$(TARGET_DEVICE)/$(TARGET_BOOTLOADER_BOARD_NAME):$(PLATFORM_VERSION)/$(BUILD_ID)/$(BUILD_NUMBER):$(TARGET_BUILD_VARIANT)/$(BUILD_VERSION_TAGS)
endif
ifneq ($(words $(BUILD_FINGERPRINT)),1)
  $(error BUILD_FINGERPRINT cannot contain spaces: "$(BUILD_FINGERPRINT)")
endif

# Display parameters shown under Settings -&gt; About Phone
ifeq ($(TARGET_BUILD_VARIANT),user)
  # User builds should show:
  # release build number or branch.buld_number non-release builds

  # Dev. branches should have DISPLAY_BUILD_NUMBER set
  ifeq "true" "$(DISPLAY_BUILD_NUMBER)"
    BUILD_DISPLAY_ID := $(BUILD_ID).$(BUILD_NUMBER)
  else
    BUILD_DISPLAY_ID := $(BUILD_ID)
  endif
else
  # Non-user builds should show detailed build information
  BUILD_DISPLAY_ID := $(build_desc)
endif

# 默认的locale设置
define default-locale
$(subst _, , $(firstword $(1)))
endef

# 默认语言和区域设置
define default-locale-language
$(word 2, 2, $(call default-locale, $(1)))
endef
define default-locale-region
$(word 3, 3, $(call default-locale, $(1)))
endef

# 使用buildinfo.sh脚本设置默认的变量
BUILDINFO_SH := build/tools/buildinfo.sh
$(INSTALLED_BUILD_PROP_TARGET): $(BUILDINFO_SH) $(INTERNAL_BUILD_ID_MAKEFILE)
	@echo Target buildinfo: $@
	@mkdir -p $(dir $@)
	$(hide) TARGET_BUILD_TYPE="$(TARGET_BUILD_VARIANT)" \
			TARGET_DEVICE="$(TARGET_DEVICE)" \
			PRODUCT_NAME="$(TARGET_PRODUCT)" \
			PRODUCT_BRAND="$(PRODUCT_BRAND)" \
			PRODUCT_DEFAULT_LANGUAGE="$(call default-locale-language,$(PRODUCT_LOCALES))" \
			PRODUCT_DEFAULT_REGION="$(call default-locale-region,$(PRODUCT_LOCALES))" \
			PRODUCT_DEFAULT_WIFI_CHANNELS="$(PRODUCT_DEFAULT_WIFI_CHANNELS)" \
			PRODUCT_MODEL="$(PRODUCT_MODEL)" \
			PRODUCT_MANUFACTURER="$(PRODUCT_MANUFACTURER)" \
			PRIVATE_BUILD_DESC="$(PRIVATE_BUILD_DESC)" \
			BUILD_ID="$(BUILD_ID)" \
			BUILD_DISPLAY_ID="$(BUILD_DISPLAY_ID)" \
			BUILD_NUMBER="$(BUILD_NUMBER)" \
			PLATFORM_VERSION="$(PLATFORM_VERSION)" \
			PLATFORM_SDK_VERSION="$(PLATFORM_SDK_VERSION)" \
			PLATFORM_VERSION_CODENAME="$(PLATFORM_VERSION_CODENAME)" \
			BUILD_VERSION_TAGS="$(BUILD_VERSION_TAGS)" \
			TARGET_BOOTLOADER_BOARD_NAME="$(TARGET_BOOTLOADER_BOARD_NAME)" \
			BUILD_FINGERPRINT="$(BUILD_FINGERPRINT)" \
			TARGET_BOARD_PLATFORM="$(TARGET_BOARD_PLATFORM)" \
			TARGET_CPU_ABI="$(TARGET_CPU_ABI)" \
			TARGET_CPU_ABI2="$(TARGET_CPU_ABI2)" \
	        bash $(BUILDINFO_SH) &gt; $@
	$(hide) if [ -f $(TARGET_DEVICE_DIR)/system.prop ]; then \
	          cat $(TARGET_DEVICE_DIR)/system.prop &gt;&gt; $@; \
	        fi
	$(if $(ADDITIONAL_BUILD_PROPERTIES), \
		$(hide) echo &gt;&gt; $@; \
		        echo "#" &gt;&gt; $@; \
		        echo "# ADDITIONAL_BUILD_PROPERTIES" &gt;&gt; $@; \
		        echo "#" &gt;&gt; $@; )
	$(hide) $(foreach line,$(ADDITIONAL_BUILD_PROPERTIES), \
		echo "$(line)" &gt;&gt; $@;)

build_desc :=
</pre>

<h4 id="toc_1.6.2.3">sdk-build.prop部分</h4>
<pre class="brush:bash">
# sdk-build.prop
#
# There are certain things in build.prop that we don't want to
# ship with the sdk; remove them.

# This must be a list of entire property keys followed by
# "=" characters, without any internal spaces.
sdk_build_prop_remove := \
	ro.build.user= \
	ro.build.host= \
	ro.product.brand= \
	ro.product.manufacturer= \
	ro.product.device=
# TODO: Remove this soon-to-be obsolete property
sdk_build_prop_remove += ro.build.product=
INSTALLED_SDK_BUILD_PROP_TARGET := $(PRODUCT_OUT)/sdk/sdk-build.prop
$(INSTALLED_SDK_BUILD_PROP_TARGET): $(INSTALLED_BUILD_PROP_TARGET)
	@echo SDK buildinfo: $@
	@mkdir -p $(dir $@)
	$(hide) grep -v "$(subst $(space),\|,$(strip \
				$(sdk_build_prop_remove)))" $&lt; &gt; $@.tmp
	$(hide) for x in $(sdk_build_prop_remove); do \
				echo "$$x"generic &gt;&gt; $@.tmp; done
	$(hide) mv $@.tmp $@
</pre>

<h2 id="toc_1.7">属性标识列表</h2>
<table>
<tr>
<th>
标识字符串
</th>
<th>
值
</th>
<th>
描述
</th>
</tr>
<tr>
<td>
ro.secure
</td>
<td>
0
</td>
<td>
adbd是否运行在root模式
</td>
</tr>
<tr>
<td>
ro.allow.mock.location
</td>
<td>
1
</td>
<td>
允许模拟地点
</td>
</tr>
<tr>
<td>
ro.debuggable
</td>
<td>
1
</td>
<td>
是否是可调试模式
</td>
</tr>
<tr>
<td>
persist.service.adb.enable
</td>
<td>
1
</td>
<td>
adb是否可用
</td>
</tr>
<tr>
<td>
ro.kernel.qemu
</td>
<td>
1
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.kernel.console
</td>
<td>
ttyS0
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.kernel.android.checkjni
</td>
<td>
1
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.kernel.android.qemud
</td>
<td>
ttyS1
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.factorytest
</td>
<td>
0
</td>
<td>
是否是工厂测试
</td>
</tr>
<tr>
<td>
ro.serialno
</td>
<td>
&nbsp;
</td>
<td>
手机序列号
</td>
</tr>
<tr>
<td>
ro.bootmode
</td>
<td>
unknown
</td>
<td>
启动模式
</td>
</tr>
<tr>
<td>
ro.baseband
</td>
<td>
unknown
</td>
<td>
基带信息
</td>
</tr>
<tr>
<td>
ro.carrier
</td>
<td>
unknown
</td>
<td>
机器的CID
</td>
</tr>
<tr>
<td>
ro.bootloader
</td>
<td>
unknown
</td>
<td>
引导程序的版本
</td>
</tr>
<tr>
<td>
ro.hardware
</td>
<td>
goldfish
</td>
<td>
CPU信息
</td>
</tr>
<tr>
<td>
ro.revision
</td>
<td>
0
</td>
<td>
硬件修订版本号
</td>
</tr>
<tr>
<td>
ro.build.id
</td>
<td>
CUPCAKE
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.build.display.id
</td>
<td>
sdk-eng 1.5 CUPCAKE 148875 test-keys
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.build.version.incremental
</td>
<td>
148875
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.build.version.sdk
</td>
<td>
3
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.build.version.release
</td>
<td>
1.5
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.build.date
</td>
<td>
Thu May 14 17:29:49 PDT 2009
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.build.date.utc
</td>
<td>
1242347389
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.build.type
</td>
<td>
eng
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.build.user
</td>
<td>
android-build
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.build.host
</td>
<td>
e-honda.mtv.corp.google.com
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.build.tags
</td>
<td>
test-keys
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.product.model
</td>
<td>
sdk
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.product.brand
</td>
<td>
generic
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.product.name
</td>
<td>
sdk
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.product.device
</td>
<td>
generic
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.product.board
</td>
<td>
&nbsp;
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.product.manufacturer
</td>
<td>
unknown
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.product.locale.language
</td>
<td>
en
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.product.locale.region
</td>
<td>
US
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.board.platform
</td>
<td>
&nbsp;
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.build.product
</td>
<td>
generic
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.build.description
</td>
<td>
sdk-eng 1.5 CUPCAKE 148875 test-keys
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.build.fingerprint
</td>
<td>
generic/sdk/generic/:1.5/CUPCAKE/148875:eng/test-keys
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
rild.libpath
</td>
<td>
/system/lib/libreference-ril.so
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
rild.libargs
</td>
<td>
-d /dev/ttyS0
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.config.notification_sound
</td>
<td>
F1_New_SMS.ogg
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
xmpp.auto-presence
</td>
<td>
true
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.config.nocheckin
</td>
<td>
yes
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
net.bt.name
</td>
<td>
Android
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
net.change
</td>
<td>
net.gprs.local-ip
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
dalvik.vm.stack-trace-file
</td>
<td>
/data/anr/traces.txt
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
persist.sys.timezone
</td>
<td>
GMT
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
persist.sys.language
</td>
<td>
en
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
persist.sys.country
</td>
<td>
US
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
persist.sys.localevar
</td>
<td>
&nbsp;
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.FOREGROUND_APP_ADJ
</td>
<td>
0
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.VISIBLE_APP_ADJ
</td>
<td>
1
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.SECONDARY_SERVER_ADJ
</td>
<td>
2
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.HOME_APP_ADJ
</td>
<td>
4
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.HIDDEN_APP_MIN_ADJ
</td>
<td>
7
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.CONTENT_PROVIDER_ADJ
</td>
<td>
14
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.EMPTY_APP_ADJ
</td>
<td>
15
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.FOREGROUND_APP_MEM
</td>
<td>
1536
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.VISIBLE_APP_MEM
</td>
<td>
2048
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.SECONDARY_SERVER_MEM
</td>
<td>
4096
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.HOME_APP_MEM
</td>
<td>
4096
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.HIDDEN_APP_MEM
</td>
<td>
5120
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.CONTENT_PROVIDER_MEM
</td>
<td>
5632
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.EMPTY_APP_MEM
</td>
<td>
6144
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
net.tcp.buffersize.default
</td>
<td>
4096,87380,110208,4096,16384,110208
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
net.tcp.buffersize.wifi
</td>
<td>
4095,87380,110208,4096,16384,110208
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
net.tcp.buffersize.umts
</td>
<td>
4094,87380,110208,4096,16384,110208
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
net.tcp.buffersize.edge
</td>
<td>
4093,26280,35040,4096,16384,35040
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
net.tcp.buffersize.gprs
</td>
<td>
4092,8760,11680,4096,8760,11680
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
init.svc.console
</td>
<td>
running
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
init.svc.servicemanager
</td>
<td>
running
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
init.svc.vold
</td>
<td>
running
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
init.svc.debuggerd
</td>
<td>
running
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
init.svc.ril-daemon
</td>
<td>
running
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
init.svc.zygote
</td>
<td>
running
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
init.svc.media
</td>
<td>
running
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
init.svc.installd
</td>
<td>
running
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
init.svc.flash_recovery
</td>
<td>
stopped
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
init.svc.goldfish-setup
</td>
<td>
stopped
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
init.svc.qemud
</td>
<td>
stopped
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
init.svc.goldfish-logcat
</td>
<td>
stopped
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ARGH
</td>
<td>
ARGH
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
net.eth0.dns1
</td>
<td>
10.0.2.3
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
net.gprs.local-ip
</td>
<td>
10.0.2.15
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.radio.use-ppp
</td>
<td>
no
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
status.battery.state
</td>
<td>
slow
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
status.battery.level
</td>
<td>
5
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
status.battery.level_raw
</td>
<td>
50
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
status.battery.level_scale
</td>
<td>
9
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.setupwizard.mode
</td>
<td>
EMULATOR、ENABLED
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.com.google.locationfeatures
</td>
<td>
1
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.com.google.gmsversion
</td>
<td>
2.3_r7
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
init.svc.adbd,value
</td>
<td>
running
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
ro.qemu.init.completed
</td>
<td>
1
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
hw.keyboards.65536.devname
</td>
<td>
qwerty2
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
sys.settings_secure_version
</td>
<td>
2
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
dev.bootcomplete
</td>
<td>
1
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
sys.settings_system_version
</td>
<td>
6
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
gsm.sim.operator.numeric
</td>
<td>
&nbsp;
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
gsm.sim.operator.alpha
</td>
<td>
&nbsp;
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
gsm.sim.operator.iso-country
</td>
<td>
&nbsp;
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
gsm.sim.state
</td>
<td>
UNKNOWN
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
adb.connected
</td>
<td>
1
</td>
<td>
&nbsp;
</td>
</tr>
</table>

<h1 id="toc_2">设置和更改属性值的实现</h1>
<ul>
<li>
Android系统在启动时加载根目录下的<code>init.rc</code>，该脚本提供了<code>setprop</code>和<code>getprop</code>来设置和获取属性值的命令语法(参见<a href="Android Init Language.html">Android Init Language</a>)。

<li>
Android系统的init进程会开启property的服务，其他进程需要连接到该服务来改变属性值，而属性的读取可以由其他进程直接获取。这种方法采用典型的C/S模式，可参考以下代码。其中一些共用的库函数在system_properties.c中实现。

</ul>

<h2 id="toc_2.1">客户端 — properties.c</h2>
<h3 id="toc_2.1.1">property_set</h3>
<pre class="brush:c++">
int property_set(const char *key, const char *value)
{
    prop_msg msg;
    unsigned resp;

    if(key == 0) return -1;
    if(value == 0) value = "";
    
    if(strlen(key) &gt;= PROP_NAME_MAX) return -1;
    if(strlen(value) &gt;= PROP_VALUE_MAX) return -1;
    
    msg.cmd = PROP_MSG_SETPROP;
    strcpy((char*) msg.name, key);
    strcpy((char*) msg.value, value);

    return send_prop_msg(&amp;msg);
}
</pre>

<h3 id="toc_2.1.2">property_get</h3>
<pre class="brush:c++">
int property_get(const char *key, char *value, const char *default_value)
{
    int len;

    len = __system_property_get(key, value);
    if(len &gt; 0) {
        return len;
    }
    
    if(default_value) {
        len = strlen(default_value);
        memcpy(value, default_value, len + 1);
    }
    return len;
}
</pre>

<h2 id="toc_2.2">服务端 — property_service.c</h2>
<h3 id="toc_2.2.1">property_perms</h3>
<pre class="brush:c++">
// 可修改属性值的白名单列表
struct {
    const char *prefix;
    unsigned int uid;
    unsigned int gid;
} property_perms[] = {
    { "net.rmnet0.",      AID_RADIO,    0 },
    { "net.gprs.",        AID_RADIO,    0 },
    { "net.ppp",          AID_RADIO,    0 },
    { "ril.",             AID_RADIO,    0 },
    { "gsm.",             AID_RADIO,    0 },
    { "persist.radio",    AID_RADIO,    0 },
    { "net.dns",          AID_RADIO,    0 },
    { "net.",             AID_SYSTEM,   0 },
    { "dev.",             AID_SYSTEM,   0 },
    { "runtime.",         AID_SYSTEM,   0 },
    { "hw.",              AID_SYSTEM,   0 },
    { "sys.",             AID_SYSTEM,   0 },
    { "service.",         AID_SYSTEM,   0 },
    { "wlan.",            AID_SYSTEM,   0 },
    { "dhcp.",            AID_SYSTEM,   0 },
    { "dhcp.",            AID_DHCP,     0 },
    { "vpn.",             AID_SYSTEM,   0 },
    { "vpn.",             AID_VPN,      0 },
    { "debug.",           AID_SHELL,    0 },
    { "log.",             AID_SHELL,    0 },
    { "service.adb.root", AID_SHELL,    0 },
    { "persist.sys.",     AID_SYSTEM,   0 },
    { "persist.service.", AID_SYSTEM,   0 },
    { "persist.security.", AID_SYSTEM,   0 },
    { NULL, 0, 0 }
};
</pre>

<h3 id="toc_2.2.2">property_get</h3>
<pre class="brush:c++">
const char* property_get(const char *name)
{
    prop_info *pi;

    if(strlen(name) &gt;= PROP_NAME_MAX) return 0;

    pi = (prop_info*) __system_property_find(name);

    if(pi != 0) {
        return pi-&gt;value;
    } else {
        return 0;
    }
}
</pre>

<h3 id="toc_2.2.3">property_set</h3>
<pre class="brush:c++">
int property_set(const char *name, const char *value)
{
    prop_area *pa;
    prop_info *pi;

    int namelen = strlen(name);
    int valuelen = strlen(value);

    if(namelen &gt;= PROP_NAME_MAX) return -1;
    if(valuelen &gt;= PROP_VALUE_MAX) return -1;
    if(namelen &lt; 1) return -1;

    pi = (prop_info*) __system_property_find(name);

    if(pi != 0) {
        /* ro.* properties may NEVER be modified once set */
        if(!strncmp(name, "ro.", 3)) return -1;

        pa = __system_property_area__;
        update_prop_info(pi, value, valuelen);
        pa-&gt;serial++;
        __futex_wake(&amp;pa-&gt;serial, INT32_MAX);
    } else {
        pa = __system_property_area__;
        if(pa-&gt;count == PA_COUNT_MAX) return -1;

        pi = pa_info_array + pa-&gt;count;
        pi-&gt;serial = (valuelen &lt;&lt; 24);
        memcpy(pi-&gt;name, name, namelen + 1);
        memcpy(pi-&gt;value, value, valuelen + 1);

        pa-&gt;toc[pa-&gt;count] =
            (namelen &lt;&lt; 24) | (((unsigned) pi) - ((unsigned) pa));

        pa-&gt;count++;
        pa-&gt;serial++;
        __futex_wake(&amp;pa-&gt;serial, INT32_MAX);
    }
    /* If name starts with "net." treat as a DNS property. */
    if (strncmp("net.", name, strlen("net.")) == 0)  {
        if (strcmp("net.change", name) == 0) {
            return 0;
        }
       /*
        * The 'net.change' property is a special property used track when any
        * 'net.*' property name is updated. It is _ONLY_ updated here. Its value
        * contains the last updated 'net.*' property.
        */
        property_set("net.change", name);
    } else if (persistent_properties_loaded &amp;&amp;
            strncmp("persist.", name, strlen("persist.")) == 0) {
        /*
         * Don't write properties to disk until after we have read all default properties
         * to prevent them from being overwritten by default values.
         */
        write_persistent_property(name, value);
    }
    property_changed(name, value);
    return 0;
}
</pre>

<h2 id="toc_2.3">共用库 — system_properties.c</h2>
<h3 id="toc_2.3.1">__system_properties_init</h3>
<pre class="brush:c++">
int __system_properties_init(void)
{
    prop_area *pa;
    int s, fd;
    unsigned sz;
    char *env;

    if(__system_property_area__ != ((void*) &amp;dummy_props)) {
        return 0;
    }

    env = getenv("ANDROID_PROPERTY_WORKSPACE");
    if (!env) {
        return -1;
    }
    fd = atoi(env);
    env = strchr(env, ',');
    if (!env) {
        return -1;
    }
    sz = atoi(env + 1);
    
    pa = mmap(0, sz, PROT_READ, MAP_SHARED, fd, 0);
    
    if(pa == MAP_FAILED) {
        return -1;
    }

    if((pa-&gt;magic != PROP_AREA_MAGIC) || (pa-&gt;version != PROP_AREA_VERSION)) {
        munmap(pa, sz);
        return -1;
    }

    __system_property_area__ = pa;
    return 0;
}
</pre>

<h3 id="toc_2.3.2">__system_property_find_nth</h3>
<pre class="brush:c++">
const prop_info *__system_property_find_nth(unsigned n)
{
    prop_area *pa = __system_property_area__;

    if(n &gt;= pa-&gt;count) {
        return 0;
    } else {
        return TOC_TO_INFO(pa, pa-&gt;toc[n]);
    }
}
</pre>

<h3 id="toc_2.3.3">__system_property_find</h3>
<pre class="brush:c++">
const prop_info *__system_property_find(const char *name)
{
    prop_area *pa = __system_property_area__;
    unsigned count = pa-&gt;count;
    unsigned *toc = pa-&gt;toc;
    unsigned len = strlen(name);
    prop_info *pi;

    while(count--) {
        unsigned entry = *toc++;
        if(TOC_NAME_LEN(entry) != len) continue;
        
        pi = TOC_TO_INFO(pa, entry);
        if(memcmp(name, pi-&gt;name, len)) continue;

        return pi;
    }

    return 0;
}
</pre>

<h3 id="toc_2.3.4">__system_property_read</h3>
<pre class="brush:c++">
int __system_property_read(const prop_info *pi, char *name, char *value)
{
    unsigned serial, len;
    
    for(;;) {
        serial = pi-&gt;serial;
        while(SERIAL_DIRTY(serial)) {
            __futex_wait(&amp;pi-&gt;serial, serial, 0);
            serial = pi-&gt;serial;
        }
        len = SERIAL_VALUE_LEN(serial);
        memcpy(value, pi-&gt;value, len + 1);
        if(serial == pi-&gt;serial) {
            if(name != 0) {
                strcpy(name, pi-&gt;name);
            }
            return len;
        }
    }
}
</pre>

<h3 id="toc_2.3.5">__system_property_get</h3>
<pre class="brush:c++">
int __system_property_get(const char *name, char *value)
{
    const prop_info *pi = __system_property_find(name);

    if(pi != 0) {
        return __system_property_read(pi, 0, value);
    } else {
        value[0] = 0;
        return 0;
    }
}
</pre>

<h3 id="toc_2.3.6">__system_property_wait</h3>
<pre class="brush:c++">
int __system_property_wait(const prop_info *pi)
{
    unsigned n;
    if(pi == 0) {
        prop_area *pa = __system_property_area__;
        n = pa-&gt;serial;
        do {
            __futex_wait(&amp;pa-&gt;serial, n, 0);
        } while(n == pa-&gt;serial);
    } else {
        n = pi-&gt;serial;
        do {
            __futex_wait(&amp;pi-&gt;serial, n, 0);
        } while(n == pi-&gt;serial);
    }
    return 0;
}
</pre>


<footer>
    <a href="index.html" id="back-home">首页</a>
    <a href="index.html" id="back-about">关于</a>
    <a href="http://www.163.com/" id="back-email">Email</a>
</footer>

</article>
</div>

</body>
</html>
