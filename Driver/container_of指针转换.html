<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>container_of指针转换</title>
    <!--格式化代码的特效脚本-->
    <script type="text/javascript" src="scripts/shCore.js"></script>
    <script type="text/javascript" src="scripts/shBrushBash.js"></script>
    <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCss.js"></script>
    <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
    <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
    <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
    <script type="text/javascript" src="scripts/shBrushJava.js"></script>
    <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
    <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
    <script type="text/javascript" src="scripts/shBrushPython.js"></script>
    <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
    <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
    <script type="text/javascript" src="scripts/shBrushScala.js"></script>
    <script type="text/javascript" src="scripts/shBrushSql.js"></script>
    <script type="text/javascript" src="scripts/shBrushVb.js"></script>
    <script type="text/javascript" src="scripts/shBrushXml.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/shCoreZenki.css"/>
    <link type="text/css" rel="stylesheet" href="styles/shThemeZenki.css"/>
    <script type="text/javascript">
        SyntaxHighlighter.all();
    </script>
    <link rel="Stylesheet" type="text/css" href="../css_style/style_zenki.css">

</head>

<body>
<div id="wrapper">
<header>

<div id="logo">
</div>

<nav>
    <ul>
        <!--<li class="first"><a href="diary/diary.html">日记</a></li>-->
     </ul>
</nav>
</header>

<article>

<!-- wrap the vimwiki html -->

<h1 id="toc_1">container_of指针转换</h1>

<div class="toc">
<ul>
<li><a href="#toc_1">container_of指针转换</a>
<ul>
<li><a href="#toc_1.1">相关文件</a>
<li><a href="#toc_1.2">container_of宏</a>
<ul>
<li><a href="#toc_1.2.1">offsetof宏</a>
</ul>
<li><a href="#toc_1.3">示例说明</a>
</ul>
</ul>
</div>

<h2 id="toc_1.1">相关文件</h2>
<pre class="brush:c">
#include &lt;linux/kernel.h&gt;
</pre>

<h2 id="toc_1.2">container_of宏</h2>
<ul>
<li>
通常C语言通过在struct中包含另一个struct来实现继承，被包含的struct称为父类。如何根据父类对象指针获取子类的对象呢？Linux Kernel中使用<code>container_of</code>宏定义。

<li>
通俗的说，就是通过<code>成员变量</code>的指针获取包<code>含它的结构体</code>的指针。
<pre class="brush:c">
/**
 * @ptr:	成员变量指针。
 * @type:	包含该成员的结构体类型。
 * @member:	成员变量名。
 *
 */
#define container_of(ptr, type, member) ({			\
	const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr);	\
	(type *)( (char *)__mptr - offsetof(type,member) );})
</pre>

</ul>

<ul>
<li>
在0地址上分配一个子类对象，并将父类的对象（参数一）保存为子类成员的临时变量__mptr。
<pre class="brush:c">
const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr);
</pre>

</ul>

<ul>
<li>
用(char *)__mptr减去member在结构体中的偏移量，得到的值就是整个结构体变量的首地址（整个宏的返回值就是这个首地址）。
<pre class="brush:c">
(type *)( (char *)__mptr - offsetof(type,member) );
</pre>

</ul>
	
<h3 id="toc_1.2.1">offsetof宏</h3>
<pre class="brush:c">
#undef offsetof
#ifdef __compiler_offsetof
#define offsetof(TYPE,MEMBER) __compiler_offsetof(TYPE,MEMBER)
#else
#define offsetof(TYPE, MEMBER) ((size_t) &amp;((TYPE *)0)-&gt;MEMBER)
#endif
</pre>

<h2 id="toc_1.3">示例说明</h2>
<ul>
<li>
该示例中，struct scull_dev包含struct cdev对象，并且对象名是m_cdev。

<ul>
<li>
第一个参数是指向结构体中父类对象的指针。

<li>
第二个参数是需要返回的子类对象类型。

<li>
第三个参数是父类对象变量字符串，由于container_of是宏定义，它将该变量名和第二个参数组合，返回其地址。

</ul>
<li>
container_of最终将m_cdev的指针转换，得到了继承子类struct scull_dev对象的指针。
<pre class="brush:c">
# scull_dev结构描述
struct scull_dev { 
    struct cdev m_cdev;
    // ...... 
};

# 指针转换方法
void convert() {
    struct scull_dev *dev; 
    dev = container_of(inode-&gt;i_cdev, struct scull_dev, m_cdev);
}
</pre>

</ul>


<footer>
    <a href="http://zenki2001cn.github.com/Wiki" id="back-home">首页</a>
    <a href="index.html" id="back-about">关于</a>
    <a href="zenki2001cn@163.com" id="back-email">Email</a>
</footer>

</article>
</div>

</body>
</html>
