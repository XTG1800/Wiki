<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>如何创建sysfs</title>
    <!--格式化代码的特效脚本-->
    <script type="text/javascript" src="scripts/shCore.js"></script>
    <script type="text/javascript" src="scripts/shBrushBash.js"></script>
    <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCss.js"></script>
    <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
    <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
    <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
    <script type="text/javascript" src="scripts/shBrushJava.js"></script>
    <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
    <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
    <script type="text/javascript" src="scripts/shBrushPython.js"></script>
    <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
    <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
    <script type="text/javascript" src="scripts/shBrushScala.js"></script>
    <script type="text/javascript" src="scripts/shBrushSql.js"></script>
    <script type="text/javascript" src="scripts/shBrushVb.js"></script>
    <script type="text/javascript" src="scripts/shBrushXml.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/shCoreZenki.css"/>
    <link type="text/css" rel="stylesheet" href="styles/shThemeZenki.css"/>
    <script type="text/javascript">
        SyntaxHighlighter.all();
    </script>
    <link rel="Stylesheet" type="text/css" href="../css_style/style_zenki.css">

</head>

<body>
<div id="wrapper">
<header>

<div id="logo">
</div>

<nav>
    <ul>
        <!--<li class="first"><a href="diary/diary.html">日记</a></li>-->
     </ul>
</nav>
</header>

<article>

<!-- wrap the vimwiki html -->

<h1 id="toc_1">如何创建sysfs</h1>

<div class="toc">
<ul>
<li><a href="#toc_1">如何创建sysfs</a>
<ul>
<li><a href="#toc_1.1">相关文件</a>
<li><a href="#toc_1.2">概述</a>
<li><a href="#toc_1.3">sysfs中的目录</a>
<li><a href="#toc_1.4">sysfs中的文件</a>
<ul>
<li><a href="#toc_1.4.1">struct kobj_type</a>
<li><a href="#toc_1.4.2">struct attribute</a>
<li><a href="#toc_1.4.3">struct bin_attribute</a>
<li><a href="#toc_1.4.4">struct attribute_group</a>
<li><a href="#toc_1.4.5">struct sysfs_ops</a>
<li><a href="#toc_1.4.6">__ATTR辅助宏</a>
</ul>
<li><a href="#toc_1.5">创建sysfs文件和链接</a>
</ul>
</ul>
</div>

<h2 id="toc_1.1">相关文件</h2>
<pre class="brush:c">
#include &lt;linux/sysfs.h&gt;
#include &lt;linux/types.h&gt;
</pre>

<h2 id="toc_1.2">概述</h2>
<ul>
<li>
sysfs虚拟文件系统背后的机制是kobject，每一个sysfs目录都对应于一个kobject。关于sysfs，需要注意以下几个要点：

<ul>
<li>
kobject在sysfs中的表现形式是目录，因此kobject_add的调用会创建一个目录。而目录中包含的文件是由属性决定。

<li>
kobject_set_name分配的名字是目录的名称。不能包含斜线字符和空格。

<li>
目录的节点位置由parent和kset成员决定。如果parent为NULL，其位置在新创建的kobject的kset中。如果parent和kset都为NULL，它被创建在顶级的目录。

</ul>
<li>
关于sysfs的相关知识，可参考<a href="../Linux/sys文件系统.html">sys文件系统</a>。

</ul>

<h2 id="toc_1.3">sysfs中的目录</h2>
<ul>
<li>
根据概述中的描述，每个kobject表现为sysfs中的目录。

</ul>

<h2 id="toc_1.4">sysfs中的文件</h2>
<ul>
<li>
sysfs中的文件是通过kobj_type结构的default_attrs成员实现的。

</ul>

<h3 id="toc_1.4.1">struct kobj_type</h3>
<ul>
<li>
sysfs_ops提供了对属性的操作方法。

<li>
default_attrs表示属性，其表现形式为sysfs中的文件。
<pre class="brush:c">
struct kobj_type {
	void (*release)(struct kobject *kobj);
	const struct sysfs_ops *sysfs_ops;
	struct attribute **default_attrs;
	const struct kobj_ns_type_operations *(*child_ns_type)(struct kobject *kobj);
	const void *(*namespace)(struct kobject *kobj);
};
</pre>

</ul>

<h3 id="toc_1.4.2">struct attribute</h3>
<ul>
<li>
name表示属性的名称，对应于sysfs中的文件名。

<li>
owner表示模块。

<li>
mode表示读写权限。
<pre class="brush:c">
struct attribute {
	const char		*name;
	struct module	*owner;
	mode_t			mode;
};
</pre>

</ul>

<h3 id="toc_1.4.3">struct bin_attribute</h3>
<ul>
<li>
bin_attribute表现为可接收二进制数据的属性文件。
<pre class="brush:c">
struct bin_attribute {
	struct attribute	attr;
	size_t			    size;
	void			    *private;
	ssize_t (*read)(struct file *, struct kobject *, struct bin_attribute *,
			        char *, loff_t, size_t);
	ssize_t (*write)(struct file *,struct kobject *, struct bin_attribute *,
			        char *, loff_t, size_t);
	int (*mmap)(struct file *, struct kobject *, struct bin_attribute *attr,
		            struct vm_area_struct *vma);
};
</pre>

</ul>

<h3 id="toc_1.4.4">struct attribute_group</h3>
<ul>
<li>
attribute_group包含一组attribute。
<pre class="brush:c">
struct attribute_group {
	const char		    *name;
	mode_t			    (*is_visible)(struct kobject *, struct attribute *, int);
	struct attribute	**attrs;
};
</pre>

</ul>

<h3 id="toc_1.4.5">struct sysfs_ops</h3>
<ul>
<li>
sysfs_ops结构为每个属性文件提供了用户空间访问的接口，其中

<ul>
<li>
show方法为用户提供了读访问。

<li>
store方法为用户提供了写访问。
<pre class="brush:c">
struct sysfs_ops {
	ssize_t	(*show)(struct kobject *, struct attribute *,char *);
	ssize_t	(*store)(struct kobject *,struct attribute *,const char *, size_t);
};
</pre>

</ul>
</ul>

<h3 id="toc_1.4.6">__ATTR辅助宏</h3>
<ul>
<li>
内核提供了__ATTR宏，使得定义一个attribute变得简单。
<pre class="brush:c">
#define __ATTR(_name,_mode,_show,_store) {                  \
	.attr = {.name = __stringify(_name), .mode = _mode },	\
	.show	= _show,					                    \
	.store	= _store,					                    \
}

#define __ATTR_RO(_name) {                                  \
	.attr	= { .name = __stringify(_name), .mode = 0444 },	\
	.show	= _name##_show,					                \
}

#define __ATTR_NULL { .attr = { .name = NULL } }
</pre>

</ul>

<h2 id="toc_1.5">创建sysfs文件和链接</h2>
<ul>
<li>
sysfs_create_file用来创建一个attribute所对应的sysfs中的文件。

<li>
sysfs_remove_file用来移除一个attribute所对应的sysfs中的文件。

<li>
sysfs_create_bin_file用来创建一个二进制的文件。

<li>
sysfs_remove_bin_file用来移除一个二进制的文件。

<li>
sysfs_create_link用来创建一个指定kobject的链接。

<li>
sysfs_remove_link用来移除一个指定kobject的链接。

<li>
以上列出了一小部分sysfs的方法，其内部是基于VFS机制，实现了一个<a href="虚拟文件系统.html">虚拟文件系统</a>，可参考内核源码kernel/fs/sysfs/目录下的内容。

</ul>


<footer>
    <a href="http://zenki2001cn.github.com/Wiki" id="back-home">首页</a>
    <a href="index.html" id="back-about">关于</a>
    <a href="zenki2001cn@163.com" id="back-email">Email</a>
</footer>

</article>
</div>

</body>
</html>
