<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>proc文件系统</title>
    <!--格式化代码的特效脚本-->
    <script type="text/javascript" src="scripts/shCore.js"></script>
    <script type="text/javascript" src="scripts/shBrushBash.js"></script>
    <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCss.js"></script>
    <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
    <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
    <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
    <script type="text/javascript" src="scripts/shBrushJava.js"></script>
    <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
    <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
    <script type="text/javascript" src="scripts/shBrushPython.js"></script>
    <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
    <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
    <script type="text/javascript" src="scripts/shBrushScala.js"></script>
    <script type="text/javascript" src="scripts/shBrushSql.js"></script>
    <script type="text/javascript" src="scripts/shBrushVb.js"></script>
    <script type="text/javascript" src="scripts/shBrushXml.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/shCoreZenki.css"/>
    <link type="text/css" rel="stylesheet" href="styles/shThemeZenki.css"/>
    <script type="text/javascript">
        SyntaxHighlighter.all();
    </script>
	<link type="text/css" rel="stylesheet" href="css_style/style_zenki.css"/>

</head>

<body>
<div id="wrapper">
<header>

<div id="logo">
</div>

<nav>
    <ul>
        <!--<li class="first"><a href="diary/diary.html">日记</a></li>-->
     </ul>
</nav>
</header>

<article>


<h1 id="toc_1">proc文件系统</h1>

<div class="toc">
<ul>
<li><a href="#toc_1">proc文件系统</a></li>
<ul>
<li><a href="#toc_1.1">/proc文件系统</a></li>
<li><a href="#toc_1.2">创建/proc文件</a></li>
<li><a href="#toc_1.3">读写/proc文件</a></li>
<li><a href="#toc_1.4">移除/proc文件</a></li>
<li><a href="#toc_1.5">示例程序</a></li>
</ul>
</ul>
</div>

<h2 id="toc_1.1">/proc文件系统</h2>
<ul>
<li>
/proc是一个特殊的文件系统类型，内核可以通过该文件系统将信息输出到用户空间。
</li>
<li>
在内核中，proc文件由struct proc_dir_entry结构来描述。
</li>
</ul>

<pre class="brush:c">
struct proc_dir_entry {
	unsigned int low_ino;
	unsigned short namelen;
	const char *name;
	mode_t mode;
	nlink_t nlink;
	uid_t uid;
	gid_t gid;
	loff_t size;
	const struct inode_operations *proc_iops;
	
	const struct file_operations *proc_fops;
	struct proc_dir_entry *next, *parent, *subdir;
	void *data;
	// 读文件的方法
	read_proc_t *read_proc;
	// 写文件的方法
	write_proc_t *write_proc;
	atomic_t count;		            /* use count */
	int pde_users;	                /* number of callers into module in progress */
	spinlock_t pde_unload_lock;     /* proc_fops checks and pde_users bumps */
	struct completion *pde_unload_completion;
	struct list_head pde_openers;	/* who did -&gt;open, but not -&gt;release */
};
</pre>

<h2 id="toc_1.2">创建/proc文件</h2>
<ul>
<li>
proc文件系统的根目录为/proc，即创建的文件最顶层的路径为/proc。通常不指定parent参数，则会在/proc下创建指定的文件。
</li>
</ul>

<pre class="brush:c">
static inline struct proc_dir_entry *proc_symlink(const char *name,
		struct proc_dir_entry *parent,const char *dest) {return NULL;}
static inline struct proc_dir_entry *proc_mkdir(const char *name,
	struct proc_dir_entry *parent) {return NULL;}

static inline struct proc_dir_entry *create_proc_read_entry(const char *name,
	mode_t mode, struct proc_dir_entry *base, 
	read_proc_t *read_proc, void * data) { return NULL; }
</pre>

<h2 id="toc_1.3">读写/proc文件</h2>
<ul>
<li>
read_proc_t方法对应于struct proc_dir_entry的read_proc成员，当用户空间读文件时调用该方法。
</li>
<ul>
<li>
page表示返回给用户的缓存区指针。
</li>
<li>
start表示缓冲区页的起始位置，如果数据小于1页，则赋值为NULL。
</li>
<li>
off表示文件指针的偏移位置。
</li>
<li>
count表示需要读取多少字节。
</li>
<li>
eof表示是否到达缓冲区末尾。如果是，则置1。
</li>
<li>
data表示附加数据，由驱动使用。
</li>
</ul>
<li>
write_proc_t方法对应于struct proc_dir_entry的write_proc成员，当用户空间写文件时调用该方法。
</li>
<ul>
<li>
file表示文件指针。
</li>
<li>
buffer表示用户空间的缓冲区冲指针。
</li>
<li>
count表示要写入的字节数。
</li>
<li>
data表示附加数据，由驱动使用。
</li>
</ul>
</ul>

<pre class="brush:c">
typedef	int (read_proc_t)(char *page, char **start, off_t off,
			  int count, int *eof, void *data);
typedef	int (write_proc_t)(struct file *file, const char __user *buffer,
			   unsigned long count, void *data);
</pre>

<h2 id="toc_1.4">移除/proc文件</h2>
<ul>
<li>
在模块移除时必须调用remove_proc_entry方法来删除/proc文件。
</li>
</ul>

<pre class="brush:c">
void remove_proc_entry(const char *name, struct proc_dir_entry *parent);
</pre>

<h2 id="toc_1.5">示例程序</h2>
<pre class="brush:c">
#include &lt;linux/init.h&gt;
#include &lt;linux/module.h&gt;
#include &lt;linux/proc_fs.h&gt;

MODULE_LICENSE("Dual BSD/GPL");

// 自定义的proc设备结构
struct test_proc_dev {
    struct proc_dir_entry *entry;
    char proc_name[64];
};
struct test_proc_dev g_proc_dev; 

// 读取proc文件的方法
int proc_read(char *page, char **start, off_t off,
			  int count, int *eof, void *data) 
{
    char *msg = "this is a proc test";
    sprintf(page, "--%s--", msg); 

    *eof = 1;
    return strlen(msg)+4;
}

// 初始化proc设备模块
void init_proc_dev(struct test_proc_dev *proc) 
{
    printk(KERN_DEBUG "init_proc_dev");
    sprintf(proc-&gt;proc_name, "%s", "test_proc_file");
    create_proc_read_entry(proc-&gt;proc_name, 0, NULL, proc_read, NULL);
}

// 移除proc设备模块
void remove_proc_dev(struct test_proc_dev *proc)
{
    printk(KERN_DEBUG "remove_proc_dev");
    remove_proc_entry(proc-&gt;proc_name, NULL);
}

// 模块初始化方法
static int test_proc_init(void)
{
    init_proc_dev(&amp;g_proc_dev);
    return 0;
}

// 模块退出方法
static void test_proc_exit(void)
{
    remove_proc_dev(&amp;g_proc_dev);
}

module_init(test_proc_init);
module_exit(test_proc_exit);
</pre>
<footer>
    <a href="index.html" id="back-home">首页</a>
    <a href="index.html" id="back-about">关于</a>
    <a href="http://www.163.com/" id="back-email">Email</a>
</footer>

</article>
</div>

<!--<script type="text/javascript">-->
<!--var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");-->
<!--document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));-->
<!--</script>-->
<!--<script type="text/javascript">-->
<!--try {-->
<!--var pageTracker = _gat._getTracker("UA-15922433-1");-->
<!--pageTracker._trackPageview();-->
<!--} catch(err) {}-->
<!--</script>-->

</body>
</html>
