<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Gerrit</title>
    <!--格式化代码的特效脚本-->
    <script type="text/javascript" src="scripts/shCore.js"></script>
    <script type="text/javascript" src="scripts/shBrushBash.js"></script>
    <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
    <script type="text/javascript" src="scripts/shBrushCss.js"></script>
    <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
    <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
    <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
    <script type="text/javascript" src="scripts/shBrushJava.js"></script>
    <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
    <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
    <script type="text/javascript" src="scripts/shBrushPython.js"></script>
    <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
    <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
    <script type="text/javascript" src="scripts/shBrushScala.js"></script>
    <script type="text/javascript" src="scripts/shBrushSql.js"></script>
    <script type="text/javascript" src="scripts/shBrushVb.js"></script>
    <script type="text/javascript" src="scripts/shBrushXml.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/shCoreZenki.css"/>
    <link type="text/css" rel="stylesheet" href="styles/shThemeZenki.css"/>
    <script type="text/javascript">
        SyntaxHighlighter.all();
    </script>
    <link rel="Stylesheet" type="text/css" href="../css_style/style_zenki.css">

</head>

<body>
<div id="wrapper">
<header>

<div id="logo">
</div>

<nav>
    <ul>
        <!--<li class="first"><a href="diary/diary.html">日记</a></li>-->
     </ul>
</nav>
</header>

<article>

<!-- wrap the vimwiki html -->

<h1 id="toc_1">Gerrit</h1>

<div class="toc">
<ul>
<li><a href="#toc_1">Gerrit</a>
<ul>
<li><a href="#toc_1.1">安装准备</a>
<li><a href="#toc_1.2">安装gerrit</a>
<ul>
<li><a href="#toc_1.2.1">运行gerrit</a>
</ul>
<li><a href="#toc_1.3">注册用户</a>
<ul>
<li><a href="#toc_1.3.1">生成ssh私钥和公钥</a>
<li><a href="#toc_1.3.2">注册账户和配置</a>
<li><a href="#toc_1.3.3">验证账户</a>
</ul>
<li><a href="#toc_1.4">使用gerrit</a>
<ul>
<li><a href="#toc_1.4.1">创建项目</a>
<li><a href="#toc_1.4.2">下载代码</a>
<li><a href="#toc_1.4.3">提交代码</a>
<li><a href="#toc_1.4.4">配置提交页面</a>
</ul>
<li><a href="#toc_1.5">参考链接</a>
</ul>
</ul>
</div>

<h2 id="toc_1.1">安装准备</h2>
<ul>
<li>
下载Gerrit：<a href="http://code.google.com/p/gerrit/">http://code.google.com/p/gerrit/</a>

<li>
Gerrit的安装指南：<a href="http://gerrit.googlecode.com/svn/documentation/2.2.1/install.html">http://gerrit.googlecode.com/svn/documentation/2.2.1/install.html</a>

<li>
安装mysql、git
<pre class="brush:bash">
$ sudo apt-get install mysql-server git git-core
</pre>

<li>
创建mysql账户
<pre class="brush:bash">
$ mysql -u root -p
mysql&gt; CREATE USER 'zenki'@'localhost' IDENTIFIED BY 'zenki007';
mysql&gt; CREATE DATABASE reviewdb;
mysql&gt; ALTER DATABASE reviewdb charset=latin1;
mysql&gt; GRANT ALL ON reviewdb.* TO 'zenki'@'localhost';
mysql&gt; FLUSH PRIVILEGES;
</pre>

</ul>

<h2 id="toc_1.2">安装gerrit</h2>
<ul>
<li>
安装前先创建一个gerrit的安装目录。同时，代码仓库的默认安装路径也在该目录下。

<li>
确认当前JAVA和JRE的环境变量所指定的版本是一致的。

<li>
执行以下命令进行安装：

<ul>
<li>
<code>Git代码库的位置</code>要指向正确的位置。默认值是位于安装目录中的'git'目录，也可以是其他不同位置（例如/var/gits等等）。应该先配置好这个路径，因为在Gerrit启动时它会先扫描该目录来添加新项目。

<li>
<code>监听地址</code>对有多个地址（例如IPv4和IPv6）的主机很有用，它可以限定使用哪个地址。*表示本地主机上的任意地址。

<li>
<code>监听端口</code>是一个端口号。29418是默认的Gerrit SSH端口，而8080是默认的Gerrit Web端口。但是如果8080已经被别的应用程序占用了，那么你可能会想修改第二个端口。

<li>
<code>身份验证方法</code>确定了如何登录Gerrit。如果你想挂入某个现有的身份验证提供方（例如Google Accounts），那么可以使用OpenID。但对测试而言（还有上面提到的范例），可以使用 development_become_any_account。键入?会显示一个可用方法的列表。
<pre class="brush:bash">
$ java -jar gerrit-full-2.5.war init -d ~/gerrit

*** Gerrit Code Review 2.5
*** 


*** Git Repositories
*** 

Location of Git repositories   [git]: 

*** SQL Database
*** 

Database server type           [MYSQL/?]: 
Server hostname                [localhost]: 
Server port                    [(MYSQL default)]: 
Database name                  [reviewdb]: 
Database username              [zenki]: 
Change zenki's password        [y/N]? 

*** User Authentication
*** 

Authentication method          [DEVELOPMENT_BECOME_ANY_ACCOUNT/?]: 

*** Email Delivery
*** 

SMTP server hostname           [localhost]: 
SMTP server port               [(default)]: 
SMTP encryption                [NONE/?]: 
SMTP username                  [zenki]: 
Change zenki's password        [y/N]? 

*** Container Process
*** 

Run as                         [zenki]: 
Java runtime                   [/usr/lib/jvm/jdk1.6.0_31/jre]: 
Upgrade /home/zenki/gerrit/bin/gerrit.war [Y/n]? 
Copying gerrit.war to /home/zenki/gerrit/bin/gerrit.war

*** SSH Daemon
*** 

Listen on address              [*]: 
Listen on port                 [29418]: 

*** HTTP Daemon
*** 

Behind reverse proxy           [y/N]? 
Use SSL (https://)             [y/N]? 
Listen on address              [*]: 
Listen on port                 [8080]: 

*** Plugins
*** 

Prompt to install core plugins [y/N]? 

Initialized /home/zenki/gerrit
</pre>

</ul>
</ul>

<h3 id="toc_1.2.1">运行gerrit</h3>
<ul>
<li>
在之前安装gerrit的目录下执行脚本，启动gerrit。
<pre class="brush:bash">
# 启动gerrit
$ ~/gerrit/bin/gerrit.sh start
# 停止gerrit
$ ~/gerrit/bin/gerrit.sh stop
# 重启gerrit
$ ~/gerrit/bin/gerrit.sh restart
</pre>

</ul>

<h2 id="toc_1.3">注册用户</h2>
<h3 id="toc_1.3.1">生成ssh私钥和公钥</h3>
<pre class="brush:bash">
# 生成私钥和公钥
$ ssh-keygen -t rsa -C "zenki2001cn@163.com"

# 添加以下信息到~/.ssh/config，用来管理登录信息
Host zenki-ubuntu
  Hostname zenki-ubuntu
  Port 29418
  User Zenki
  IdentityFile ~/.ssh/id_rsa

# 添加rsa密钥
$ ssh-add ~/.ssh/id_rsa

# 启用ssh-agent
$ ssh-agent 
</pre>

<h3 id="toc_1.3.2">注册账户和配置</h3>
<ul>
<li>
一切就绪后，使用浏览器，打开<a href="http://localhost:8080">http://localhost:8080</a> 此时，会出现gerrit的登录界面。

<li>
点击右上角的<a href="http://localhost:8080/become">Become</a>注册新账户。

<ul>
<li>
注册使用的邮箱，需要和git config中配置的邮箱一致，否则，在提交代码时会报错。

</ul>
<li>
登录账户后，点击<a href="http://localhost:8080/\#/settings/">settings</a>进行账户设置，其中需要设置ssh公钥和一些信息。

</ul>
<p>
<img src="http:pic/import_pub_key.png" />
</p>

<h3 id="toc_1.3.3">验证账户</h3>
<pre class="brush:bash">
$ ssh -p 29418 zenki@localhost

# 出现以下信息时，说明ssh能够正常工作：
 ****    Welcome to Gerrit Code Review    ****

  Hi demo, you have successfully connected over SSH.

  Unfortunately, interactive shells are disabled.
  To clone a hosted Git repository, use:

  git clone ssh://demo@localhost:29418/REPOSITORY_NAME.git

Connection to localhost closed.
</pre>

<h2 id="toc_1.4">使用gerrit</h2>
<h3 id="toc_1.4.1">创建项目</h3>
<ul>
<li>
可以通过命令行创建：
<pre class="brush:bash">
$ ssh -p 29418 zenki@localhost gerrit create-project --name example.git
</pre>

<li>
也可以通过web页面创建一个新的项目：

</ul>
<p>
<img src="http:pic/create_project.png" />
</p>

<h3 id="toc_1.4.2">下载代码</h3>
<pre class="brush:bash">
# ssh方式
$ git clone ssh://Zenki.J.Zha@127.0.0.1:29418/Gerrit_project_test.git
# http方式
$ git clone http://Zenki.J.Zha@127.0.0.1:8080/Gerrit_project_test.git
# https方式，如果之前配置了SSL加密
$ git clone https://Zenki.J.Zha@127.0.0.1:8080/Gerrit_project_test.git
</pre>

<h3 id="toc_1.4.3">提交代码</h3>
<ul>
<li>
提交代码时会遇到错误信息，此时，需要将其推送到另一个分支。然后等待code review后，由管理员进行提交。
<pre class="brush:bash">
$ git config remote.origin.push refs/heads/*:refs/for/*
$ git push origin
# 或者
$ git push origin HEAD:refs/for/master

# 成功的信息
Counting objects: 3, done.
Writing objects: 100% (3/3), 217 bytes, done.
Total 3 (delta 0), reused 0 (delta 0)
To ssh://demo@localhost:29418/example.git
 * [new branch]      master -&gt; refs/for/master
</pre>

</ul>

<h3 id="toc_1.4.4">配置提交页面</h3>
<ul>
<li>
进入项目管理，点击<a href="http://localhost:8080/\#/admin/projects/All-Projects,access">Access</a>打开项目权限设置的页面，需要添加两个选项Label Verified和Submit。添加结果如下：

<li>
通过code review后的代码，便可以由管理员提交到仓库中，其他成员才可以同步更新这些代码。

</ul>
<p>
<img src="http:pic/submit.png" />
</p>

<h2 id="toc_1.5">参考链接</h2>
<ul>
<li>
<a href="http://www.infoq.com/cn/articles/Gerrit-jenkins-hudson">http://www.infoq.com/cn/articles/Gerrit-jenkins-hudson</a>

<li>
<a href="http://fatalove.iteye.com/blog/1332881">http://fatalove.iteye.com/blog/1332881</a>

<li>
<a href="http://www.lifeyun.com/code-review-tools-installation-gerrit.html">http://www.lifeyun.com/code-review-tools-installation-gerrit.html</a>

</ul>


<footer>
    <a href="http://zenki2001cn.github.com/Wiki" id="back-home">首页</a>
    <a href="index.html" id="back-about">关于</a>
    <a href="zenki2001cn@163.com" id="back-email">Email</a>
</footer>

</article>
</div>

</body>
</html>
